<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sparkle's Static Lab</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Global Styles */
    body { 
      font-family: 'Comic Neue', 'Comic Sans MS', sans-serif; 
      background-color: #f0f9ff; 
      margin: 0;
      overflow-x: hidden;
      touch-action: pan-y;
    }
    .sim-container { touch-action: none; }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-6px); }
      100% { transform: translateY(0px); }
    }
    .floating { animation: float 3s ease-in-out infinite; }
    
    .particle { transition: all 0.5s ease-out; }
    .animate-spin-slow { animation: spin 10s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Physics & Interaction Classes */
    .draggable { cursor: grab; touch-action: none; }
    .draggable:active { cursor: grabbing; }
    
    .no-lag { transition: none; }
    .smooth-catchup { transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }

    .flying-electron {
      animation: flyToTarget 0.6s ease-out forwards;
    }
    @keyframes flyToTarget {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
    }

    .speech-bubble::before {
      content: '';
      position: absolute;
      left: -12px;
      top: 24px;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 12px solid #FCD34D; 
    }

    @keyframes pointMove {
      0% { transform: translateX(0); opacity: 0.5; }
      50% { transform: translateX(10px); opacity: 1; }
      100% { transform: translateX(0); opacity: 0.5; }
    }
    .arrow-anim { animation: pointMove 1.5s infinite; }

    /* Custom Scrollbar for nicer UI */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Confetti Animation */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #f00;
      animation: fall linear forwards;
    }
    @keyframes fall {
      to { transform: translateY(100vh) rotate(720deg); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // --- Audio Engine (Web Audio API) ---
    // Initialize lazily to handle browser autoplay policies
    let audioCtx = null;

    const initAudio = () => {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    };

    // -- Background Music Notes (Pentatonic Scale) --
    const melody = [
      261.63, 293.66, 329.63, 392.00, 440.00, 392.00, 329.63, 293.66,
      261.63, 261.63, 329.63, 329.63, 293.66, 293.66, 261.63, 261.63
    ];

    const playMusicNote = (index) => {
        if (!audioCtx || audioCtx.state === 'suspended') return;
        
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        const freq = melody[index % melody.length];
        
        // 8-bit Triangle wave
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(freq / 2, now); 
        
        // Soft envelope
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.05, now + 0.1); 
        gainNode.gain.linearRampToValueAtTime(0.03, now + 0.5); 
        gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
        
        osc.start(now);
        osc.stop(now + 0.8);
    };

    const playSound = (type) => {
      initAudio(); // Ensure context is ready
      if (!audioCtx) return;

      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      const now = audioCtx.currentTime;

      switch (type) {
        case 'pop':
          osc.type = 'sine';
          osc.frequency.setValueAtTime(800, now);
          osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
          gainNode.gain.setValueAtTime(0.1, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
          osc.start(now);
          osc.stop(now + 0.1);
          break;
        case 'blip': 
          osc.type = 'square';
          osc.frequency.setValueAtTime(400, now);
          osc.frequency.setValueAtTime(600, now + 0.05);
          gainNode.gain.setValueAtTime(0.03, now);
          gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
          osc.start(now);
          osc.stop(now + 0.1);
          break;
        case 'zap':
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(500, now);
          osc.frequency.linearRampToValueAtTime(100, now + 0.2);
          gainNode.gain.setValueAtTime(0.1, now);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
          osc.start(now);
          osc.stop(now + 0.2);
          break;
        case 'rub':
          // White noise approximation
          const bufferSize = audioCtx.sampleRate * 0.1;
          const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
          const data = buffer.getChannelData(0);
          for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
          const noise = audioCtx.createBufferSource();
          noise.buffer = buffer;
          const noiseGain = audioCtx.createGain();
          noiseGain.gain.setValueAtTime(0.05, now);
          noiseGain.gain.linearRampToValueAtTime(0, now + 0.1);
          noise.connect(noiseGain);
          noiseGain.connect(audioCtx.destination);
          noise.start(now);
          break;
        case 'roll': 
          osc.type = 'square';
          osc.frequency.setValueAtTime(100, now);
          osc.frequency.exponentialRampToValueAtTime(50, now + 0.15);
          gainNode.gain.setValueAtTime(0.05, now);
          gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
          osc.start(now);
          osc.stop(now + 0.15);
          break;
        case 'swish': 
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(200, now);
          osc.frequency.linearRampToValueAtTime(400, now + 0.2);
          gainNode.gain.setValueAtTime(0.05, now);
          gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
          osc.start(now);
          osc.stop(now + 0.2);
          break;
        case 'thump':
           osc.type = 'sine';
           osc.frequency.setValueAtTime(100, now);
           osc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
           gainNode.gain.setValueAtTime(0.2, now);
           gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
           osc.start(now);
           osc.stop(now + 0.1);
           break;
        case 'success':
          osc.type = 'sine';
          osc.frequency.setValueAtTime(440, now);
          osc.frequency.setValueAtTime(554, now + 0.1); 
          osc.frequency.setValueAtTime(659, now + 0.2); 
          gainNode.gain.setValueAtTime(0.1, now);
          gainNode.gain.linearRampToValueAtTime(0, now + 0.4);
          osc.start(now);
          osc.stop(now + 0.4);
          break;
        case 'win':
          const notes = [523.25, 659.25, 783.99, 1046.50];
          notes.forEach((f, i) => {
             const osc2 = audioCtx.createOscillator();
             const gn2 = audioCtx.createGain();
             osc2.connect(gn2);
             gn2.connect(audioCtx.destination);
             osc2.type = 'triangle';
             osc2.frequency.setValueAtTime(f, now + i*0.1);
             gn2.gain.setValueAtTime(0.1, now + i*0.1);
             gn2.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.4);
             osc2.start(now + i*0.1);
             osc2.stop(now + i*0.1 + 0.4);
          });
          break;
        case 'fail':
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(150, now);
          osc.frequency.linearRampToValueAtTime(100, now + 0.3);
          gainNode.gain.setValueAtTime(0.1, now);
          gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
          osc.start(now);
          osc.stop(now + 0.3);
          break;
      }
    };

    // --- Components ---

    const Button = ({ onClick, children, disabled, className = "" }) => (
      <button 
        onClick={(e) => { playSound('pop'); onClick(e); }} 
        disabled={disabled}
        className={`px-6 py-2 rounded-full font-bold shadow-lg transform transition active:scale-95 ${disabled ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-400 text-white'} ${className}`}
      >
        {children}
      </button>
    );

    const GuideArrow = ({ text, className = "", direction = "right" }) => (
      <div className={`absolute pointer-events-none z-40 flex items-center ${className} ${direction === "left" ? "flex-row-reverse" : ""}`}>
        <span className="bg-white/90 px-2 py-1 rounded text-xs font-bold text-blue-600 shadow-sm whitespace-nowrap">{text}</span>
        <div className={`text-4xl text-blue-500 font-bold arrow-anim ${direction === "left" ? "rotate-180" : ""}`}>&rarr;</div>
      </div>
    );

    // Reusable Charge Bubble Component for Consistency
    const ChargeCircle = ({ type, size = "md", animate = false, className="", style={} }) => {
        const sizeClass = size === "sm" ? "w-4 h-4 text-[10px]" : (size === "lg" ? "w-8 h-8 text-xl" : "w-6 h-6 text-sm");
        const colorClass = type === 'pos' ? "bg-red-500 text-white" : "bg-blue-500 text-white"; 
        const sign = type === 'pos' ? '+' : '-';
        
        return (
            <div style={style} className={`${sizeClass} rounded-full flex items-center justify-center font-bold shadow-sm border border-white/30 select-none ${colorClass} ${animate ? 'animate-pulse' : ''} ${className}`}>
                {sign}
            </div>
        )
    };

    const Sparkle = ({ message, emotion = 'happy', speak = true }) => {
      const [isSpeaking, setIsSpeaking] = useState(false);

      useEffect(() => {
        if (!speak) {
          window.speechSynthesis.cancel();
          return;
        }
        window.speechSynthesis.cancel();
        
        // --- SPEECH CLEANING LOGIC ---
        // remove (0), remove /, remove markdown
        // ALSO remove "1. ", "2. " bullets at start of lines for smoother reading
        const spokenText = message
            .replace(/^\d+\.\s*/gm, '') // Remove list bullets "1. "
            .replace(/\(0\)/g, '') 
            .replace(/\//g, ' ') 
            .replace(/[\*\_\-\+]/g, ' '); 

        const utterance = new SpeechSynthesisUtterance(spokenText);
        utterance.lang = 'en-US';
        utterance.pitch = 1.2; 
        utterance.rate = 1.0; 
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
        if (preferredVoice) utterance.voice = preferredVoice;
        utterance.onstart = () => setIsSpeaking(true);
        utterance.onend = () => setIsSpeaking(false);
        utterance.onerror = () => setIsSpeaking(false);
        window.speechSynthesis.speak(utterance);
        return () => window.speechSynthesis.cancel();
      }, [message, speak]);

      return (
        <div className="flex items-start gap-4 mb-6 w-full max-w-4xl animate-fadeIn z-50 relative">
          <div className="flex-shrink-0 flex flex-col items-center">
            <div className="text-8xl relative floating">
              <span role="img" aria-label="Sparkle" className="inline-block origin-bottom" style={{ filter: emotion === 'shocked' ? 'invert(1)' : 'none' }}>
                {emotion === 'shocked' ? 'üò≤' : 'üë©'}
              </span>
              <div className="absolute -top-2 -right-4 text-5xl text-yellow-600 font-bold z-20 drop-shadow-md">‚ö°</div>
              {isSpeaking && <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-full h-1 bg-yellow-400/50 blur-sm animate-pulse"></div>}
            </div>
            <div className="font-bold text-purple-800 mt-2 bg-purple-200 px-3 py-0.5 rounded-full text-sm border border-purple-400 shadow-sm">Sparkle</div>
          </div>
          <div className="bg-white border-l-8 border-yellow-300 p-5 rounded-r-xl rounded-bl-xl shadow-md flex-grow relative speech-bubble mt-4 transition-all">
            <div className="text-gray-800 font-medium leading-relaxed text-lg whitespace-pre-line">{message}</div>
          </div>
        </div>
      );
    };

    // --- STAGE 0: Intro ---
    const IntroScreen = ({ onComplete, settings }) => {
        // Just the spoken welcome, no list
        const spokenWelcome = "Welcome LaSallian Scientists! I'm Sparkle. Check out our checklist of experiments below!";
        
        return (
            <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
                <Sparkle message={spokenWelcome} speak={settings.speak} />
                
                <div className="bg-white/80 p-6 rounded-xl shadow-lg border-2 border-purple-200 max-w-lg w-full mt-4">
                    <h2 className="text-2xl font-bold text-purple-800 mb-4 font-comic text-center">Lab Checklist üìã</h2>
                    <ul className="text-left text-gray-700 font-medium space-y-2 mb-6 ml-4">
                        <li>1. Build an Atom ‚öõÔ∏è</li>
                        <li>2. Explore Electron Shells üîµ</li>
                        <li>3. Master Attraction & Repulsion üß≤</li>
                        <li>4. Charge a Comb üíá‚Äç‚ôÄÔ∏è</li>
                        <li>5. The Balloon Experiments üéà</li>
                        <li>6. Real Life Examples üå©Ô∏è</li>
                    </ul>
                    <div className="text-center">
                        <Button onClick={onComplete} className="text-2xl px-10 py-4 bg-green-500 hover:bg-green-600 transform hover:scale-105 transition-all shadow-xl">
                            Enter the Lab üöÄ
                        </Button>
                        <p className="text-gray-500 text-sm mt-4 italic">Clicking start enables the lab equipment sound system.</p>
                    </div>
                </div>
            </div>
        )
    };

    // --- STAGE 1: Atom Builder ---
    const AtomBuilder = ({ onComplete, settings }) => {
      const [protons, setProtons] = useState(0);
      const [neutrons, setNeutrons] = useState(0);
      const [electrons, setElectrons] = useState(0);
      const isComplete = protons === 3 && neutrons === 4 && electrons === 3;
      
      const getPos = (index) => {
        const angle = index * 2.39996; 
        // 16 is tight but readable for w-6/w-5 circles
        const r = 16 * Math.sqrt(index); 
        return { x: r * Math.cos(angle), y: r * Math.sin(angle) };
      };

      return (
        <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
          <h2 className="text-2xl font-bold mb-4 text-purple-600">Mission 1: Inside the Atom</h2>
          <Sparkle message={isComplete ? "Perfect! That's a stable Lithium atom." : "Let's build a Lithium atom! I need 3 Protons (+), 4 Neutrons (0), and 3 Electrons (-)."} emotion={isComplete ? 'excited' : 'happy'} speak={settings.speak} />

          <div className="relative w-80 h-80 md:w-96 md:h-96 bg-gray-900 rounded-full flex items-center justify-center mb-6 overflow-hidden ring-4 ring-gray-200 shadow-xl">
            <div className="absolute w-64 h-64 border-2 border-dashed border-gray-600 rounded-full animate-spin-slow" style={{animationDuration: '10s'}}></div>
            <div className="absolute w-48 h-48 border-2 border-dashed border-gray-600 rounded-full animate-spin-slow" style={{animationDuration: '5s'}}></div>
            
            <div className="absolute w-24 h-24 flex items-center justify-center z-10 transition-all duration-300">
              {Array.from({ length: protons }).map((_, i) => {
                const pos = getPos(i);
                return <ChargeCircle key={`p-${i}`} type="pos" className="absolute" style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }} />;
              })}
              {Array.from({ length: neutrons }).map((_, i) => {
                const pos = getPos(protons + i);
                return <div key={`n-${i}`} className="absolute w-6 h-6 bg-gray-400 rounded-full border border-gray-300" style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }}></div>;
              })}
            </div>

            {Array.from({ length: electrons }).map((_, i) => {
              const angle = (i / electrons) * 2 * Math.PI;
              const radius = 100 + (i % 2) * 30;
              const x = Math.cos(angle) * radius;
              const y = Math.sin(angle) * radius;
              // High z-index to ensure visibility
              return <ChargeCircle key={`e-${i}`} type="neg" className="absolute shadow-glow z-20" style={{ transform: `translate(${x}px, ${y}px)` }} />;
            })}
          </div>

          <div className="grid grid-cols-3 gap-4 mb-4">
            {[{l:'Protons (+)', c:protons, s:setProtons, col:'red'}, {l:'Neutrons (0)', c:neutrons, s:setNeutrons, col:'gray'}, {l:'Electrons (-)', c:electrons, s:setElectrons, col:'yellow'}].map((item, idx) => (
              <div key={idx} className="flex flex-col items-center">
                <span className={`font-bold text-${item.col}-600 mb-1`}>{item.l}</span>
                <div className="flex gap-2 items-center">
                  <Button onClick={() => item.s(Math.max(0, item.c - 1))} className={`px-2 py-1 bg-${item.col}-200 text-black hover:bg-${item.col}-300`}>-</Button>
                  <span className="text-xl font-mono w-6 text-center">{item.c}</span>
                  <Button onClick={() => item.s(item.c + 1)} className={`px-2 py-1 bg-${item.col}-500 hover:bg-${item.col}-600`}>+</Button>
                </div>
              </div>
            ))}
          </div>

          {isComplete && (
            <div className="mt-6 animate-bounce">
              <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3">Next Lab &rarr;</Button>
            </div>
          )}
        </div>
      );
    };

    // --- STAGE 2: Electron Shells ---
    const ElectronShellLevel = ({ onComplete, settings }) => {
      const [knocked, setKnocked] = useState(false);
      return (
        <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
          <h2 className="text-2xl font-bold mb-4 text-purple-600">Mission 2: Why do they move?</h2>
          <Sparkle message={knocked ? "See that? The nucleus holds tight, but that outer electron is loose!" : "The Nucleus is protected deep inside. But look at the Outside Shell... tap that electron!"} emotion={knocked ? 'excited' : 'happy'} speak={settings.speak} />

          <div className="relative w-full h-80 bg-gray-900 rounded-xl flex items-center justify-center overflow-hidden border-4 border-gray-700">
            {!knocked && <GuideArrow text="Tap me!" className="top-1/3 right-1/3" direction="left" />}
            <div className="relative w-64 h-64 flex items-center justify-center">
              <div className="absolute w-32 h-32 bg-gray-800 rounded-full flex flex-col items-center justify-center z-10 border-4 border-gray-600 gap-2">
                 <div className="flex gap-1"><ChargeCircle type="pos"/><ChargeCircle type="pos"/></div>
                 <div className="text-[10px] text-gray-300 font-bold">Nucleus</div>
              </div>
              <div className="absolute inset-0 border-2 border-dashed border-gray-500 rounded-full"></div>
              <div 
                onClick={() => { setKnocked(true); if(settings.sound) playSound('zap'); }}
                className={`absolute cursor-pointer transition-transform z-20 ${knocked ? 'flying-electron' : 'animate-bounce'}`}
                style={{ top: '50%', right: '-1.5rem', marginTop: '-1.5rem', '--tx': '200px', '--ty': '-200px' }}
              >
                <ChargeCircle type="neg" size="lg" />
              </div>
            </div>
          </div>
          <div className="mt-6 text-center">
            {knocked && <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3">Next &rarr;</Button>}
          </div>
        </div>
      );
    };

    // --- STAGE 3: Charges ---
    const ChargesLevel = ({ onComplete, settings }) => {
      const [chargeL, setChargeL] = useState('pos');
      const [chargeR, setChargeR] = useState('pos');
      const [animating, setAnimating] = useState(false);
      const [tested, setTested] = useState(false);
      const isAttract = chargeL !== chargeR;
      const isRepel = chargeL === chargeR;

      const handleTest = () => {
        setAnimating(true);
        if(settings.sound) playSound(isAttract ? 'swish' : 'zap');
        setTimeout(() => { setAnimating(false); setTested(true); }, 1000);
      };

      useEffect(() => { setTested(false); setAnimating(false); }, [chargeL, chargeR]);

      const msg = tested 
        ? (isAttract ? "Correct! Opposites Attract. Positive and Negative pull towards each other." : "Correct! Like charges Repel. Two of the same charge push away.") 
        : "Set the charges and hit Test. Do opposites attract or repel?";

      return (
        <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
          <h2 className="text-2xl font-bold mb-4 text-purple-600">Mission 3: Attraction & Repulsion</h2>
          <Sparkle message={msg} speak={settings.speak} />

          <div className="relative w-full h-64 bg-gray-100 rounded-xl border-2 border-gray-300 flex items-center justify-center gap-20 overflow-hidden">
            <div className={`transition-all duration-700 ${animating || tested ? (isAttract ? 'translate-x-[40px]' : '-translate-x-[60px]') : ''}`}>
                <ChargeCircle type={chargeL} size="lg" className="w-20 h-20 text-4xl shadow-xl" />
            </div>
            <div className="flex flex-col items-center justify-center h-full w-20">
              {tested && isAttract && <div className="text-4xl font-bold text-green-500 animate-pulse">‚Üí ‚Üê</div>}
              {tested && isRepel && <div className="text-4xl font-bold text-red-500 animate-pulse">‚Üê ‚Üí</div>}
            </div>
            <div className={`transition-all duration-700 ${animating || tested ? (isAttract ? '-translate-x-[40px]' : 'translate-x-[60px]') : ''}`}>
                <ChargeCircle type={chargeR} size="lg" className="w-20 h-20 text-4xl shadow-xl" />
            </div>
          </div>

          <div className="flex justify-between w-full max-w-md mt-6 gap-8">
            <div className="flex gap-2">
              <Button onClick={() => setChargeL('pos')} disabled={chargeL === 'pos'} className={chargeL === 'pos' ? 'ring-2 ring-red-500' : 'opacity-50'}>+</Button>
              <Button onClick={() => setChargeL('neg')} disabled={chargeL === 'neg'} className={chargeL === 'neg' ? 'ring-2 ring-blue-500' : 'opacity-50'}>-</Button>
            </div>
            <Button onClick={handleTest} className="bg-purple-600 w-32">Test!</Button>
            <div className="flex gap-2">
              <Button onClick={() => setChargeR('pos')} disabled={chargeR === 'pos'} className={chargeR === 'pos' ? 'ring-2 ring-red-500' : 'opacity-50'}>+</Button>
              <Button onClick={() => setChargeR('neg')} disabled={chargeR === 'neg'} className={chargeR === 'neg' ? 'ring-2 ring-blue-500' : 'opacity-50'}>-</Button>
            </div>
          </div>
          <div className="mt-8 h-12">{tested && <Button onClick={onComplete} className="bg-green-500 text-xl px-8 py-3">Next &rarr;</Button>}</div>
        </div>
      )
    };

    // --- STAGE 4: Comb ---
    const CombLab = ({ onComplete, settings }) => {
      const [charge, setCharge] = useState(0);
      const [flyingElectrons, setFlyingElectrons] = useState([]);
      const [combPos, setCombPos] = useState({ x: 30, y: 10 }); 

      const handleMove = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = ((clientX - rect.left) / rect.width) * 100;
        const y = ((clientY - rect.top) / rect.height) * 100;
        setCombPos({ x: Math.min(90, Math.max(10, x)), y: Math.min(80, Math.max(5, y)) });

        if (y > 50 && x > 20 && x < 80) {
          if (charge < 12 && Math.random() > 0.85) {
            if(settings.sound) playSound('rub');
            const id = Date.now();
            setFlyingElectrons(prev => [...prev, { id, x: Math.random() * 50, y: Math.random() * 20 }]);
            setTimeout(() => {
              setCharge(c => c + 1);
              setFlyingElectrons(prev => prev.filter(e => e.id !== id));
            }, 600);
          }
        }
      };

      return (
        <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
          <h2 className="text-2xl font-bold mb-4 text-purple-600">Mission 4: Charging the Comb</h2>
          <Sparkle message="Steal electrons! Rub the plastic comb on the hair. The friction knocks electrons off the hair and onto the comb." speak={settings.speak} />

          <div className="relative w-full h-80 bg-pink-50 rounded-xl border-2 border-pink-200 overflow-hidden select-none touch-none cursor-none" onMouseMove={handleMove} onTouchMove={handleMove}>
            {charge < 3 && <GuideArrow text="Rub here!" className="bottom-20 left-1/2 -translate-x-1/2" direction="down" />}
            
            {/* Hair */}
            <div className="absolute bottom-[-15px] left-1/4 w-1/2 h-64 pointer-events-none">
              {Array.from({length: 30}).map((_,i) => <div key={i} className="absolute bottom-0 w-1 bg-yellow-800 origin-bottom" style={{height: `${120 + Math.random()*80}%`, left: `${i*3.5}%`, transform: `rotate(${(i-15)*2.5}deg)`}}></div>)}
              <div className="absolute bottom-0 w-full h-20 bg-yellow-900 rounded-t-full flex justify-center items-end pb-2"><span className="text-white opacity-50">HAIR</span></div>
            </div>

            {/* Comb */}
            <div className="absolute w-64 h-24 bg-purple-600 rounded-lg transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-center z-20 shadow-xl pointer-events-none" style={{ left: `${combPos.x}%`, top: `${combPos.y}%` }}>
              <div className="w-full h-4 bg-purple-700 mt-auto flex justify-around">{Array.from({length:15}).map((_,i) => <div key={i} className="w-1 h-8 bg-purple-600"></div>)}</div>
              <div className="absolute top-2 text-white font-bold opacity-80">COMB</div>
              <div className="absolute top-0 right-0 flex flex-wrap w-full h-full p-2 gap-1 justify-center">
                {Array.from({length: charge}).map((_, i) => <ChargeCircle key={i} type="neg" size="sm" animate={true} />)}
              </div>
            </div>

            {flyingElectrons.map(e => (
              <div key={e.id} className="absolute bottom-20 left-1/2 flying-electron" style={{ '--tx': '0px', '--ty': '-150px' }}><ChargeCircle type="neg" /></div>
            ))}
          </div>
          <div className="mt-4 text-center"><p className="text-lg">Electrons Stolen: <span className="font-bold text-xl">{charge} / 12</span></p></div>
          {charge >= 12 && <div className="mt-6 animate-bounce"><Button onClick={onComplete} className="bg-green-500 text-xl px-8 py-3">Next Lab &rarr;</Button></div>}
        </div>
      );
    };

    // --- STAGE 5: Balloon Lab ---
    const BalloonLab = ({ onComplete, settings }) => {
      const [subStage, setSubStage] = useState('charge'); 
      const [charge, setCharge] = useState(0);
      const [flying, setFlying] = useState([]);
      const [isComplete, setIsComplete] = useState(false);
      const [papers, setPapers] = useState(Array.from({length: 12}).map((_,i) => ({id:i, initialX: 20 + i*6, clumpOffset: (Math.random() * 10) - 5, lifted: false})));
      const [canX, setCanX] = useState(20);
      const [balloonPos, setBalloonPos] = useState({ x: 80, y: 30 }); 
      const targetPos = useRef({ x: 80, y: 30 });
      const requestRef = useRef();

      const animate = useCallback(() => {
        setBalloonPos(prev => {
            const dx = targetPos.current.x - prev.x;
            const dy = targetPos.current.y - prev.y;
            if (Math.abs(dx) < 0.1 && Math.abs(dy) < 0.1) return prev;
            return { x: prev.x + dx * 0.15, y: prev.y + dy * 0.15 };
        });
        requestRef.current = requestAnimationFrame(animate);
      }, []);

      useEffect(() => { requestRef.current = requestAnimationFrame(animate); return () => cancelAnimationFrame(requestRef.current); }, [animate]);

      useEffect(() => {
        if (subStage === 'paper') {
          setPapers(prev => prev.map(p => {
            const dist = Math.abs(p.initialX - balloonPos.x);
            const isClose = dist < 20 && balloonPos.y > 50; 
            if (charge > 5 && isClose && !p.lifted) { if(settings.sound && Math.random()>0.8) playSound('swish'); return {...p, lifted: true}; }
            if ((dist > 25 || balloonPos.y < 40) && p.lifted) return {...p, lifted: false};
            return p;
          }));
        } else if (subStage === 'can') {
          const dist = balloonPos.x - canX;
          if (charge > 5 && Math.abs(dist) < 35 && Math.abs(dist) > 5 && balloonPos.y > 50) {
            setCanX(prev => {
              // Reduced speed from 0.8 to 0.1 for noticeably slower rolling
              const next = prev + (dist > 0 ? 0.1 : -0.1);
              if(settings.sound && Math.random()>0.9) playSound('roll'); 
              return Math.max(5, Math.min(95, next));
            });
          }
        }
      }, [balloonPos, subStage, charge, canX, settings.sound]);

      const handleInteraction = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = ((clientX - rect.left) / rect.width) * 100;
        const y = ((clientY - rect.top) / rect.height) * 100;
        targetPos.current = { x, y };

        if (subStage === 'charge' && x > 60 && y > 60) {
            if (charge < 15 && Math.random() > 0.8) {
              if(settings.sound) playSound('rub');
              const id = Date.now();
              setFlying(prev => [...prev, {id}]);
              setTimeout(() => { setCharge(c => c + 1); setFlying(prev => prev.filter(x => x.id !== id)); }, 500);
            }
        } else if (subStage === 'wall' && x < 20 && charge > 5 && !isComplete) {
             if(settings.sound) playSound('thump');
             setTimeout(() => { if(settings.sound) playSound('success'); }, 200);
             setIsComplete(true);
        }
      };

      const getMsg = () => {
        if(subStage==='charge') return "Rub the balloon on the sweater to steal negative electrons!";
        if(subStage==='paper') return "Hover over the paper. The negative balloon pushes paper electrons away, leaving positive tops. Opposites attract!";
        if(subStage==='can') return "The can is neutral, but the balloon polarizes it. Pull the can across the table!";
        return "Stick the balloon to the wall! It pushes wall electrons deeper, sticking to the positive surface.";
      };

      return (
        <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
          <div className="w-full flex flex-col md:flex-row gap-4 mb-4">
            <div className="flex-1"><Sparkle message={getMsg()} speak={settings.speak} /></div>
            {/* Microscope */}
            {['charge', 'paper', 'can'].includes(subStage) && (
              <div className="w-full md:w-64 bg-blue-50 rounded-xl border-4 border-blue-200 p-3 shadow-inner h-64 md:h-auto">
                <h4 className="font-bold text-blue-800 text-center mb-2 border-b border-blue-200">Microscope üî¨</h4>
                <div className="bg-white rounded-lg border border-gray-300 h-48 flex flex-col overflow-hidden">
                  <div className="h-1/2 bg-purple-500 flex flex-wrap gap-1 items-center justify-center p-2 relative">
                    <span className="absolute top-0 left-1 text-white/50 text-[10px]">Balloon</span>
                    {charge > 0 ? Array.from({length: Math.min(charge, 10)}).map((_,i)=><ChargeCircle key={i} type="neg" size="sm" />) : <span className="text-white/60 text-xs">Neutral</span>}
                  </div>
                  <div className="h-1/2 bg-gray-100 flex flex-col items-center justify-center p-2 relative">
                     <span className="absolute bottom-0 right-1 text-gray-400 text-[10px]">Target</span>
                     {subStage === 'charge' ? (
                        <div className="flex gap-2">{Array.from({length: 5}).map((_,i)=><div key={i} className="flex flex-col items-center"><ChargeCircle type="pos" size="sm"/>{i<(15-charge) && <ChargeCircle type="neg" size="sm" className="-mt-3"/>}</div>)}</div>
                     ) : (
                        <div className="flex flex-col gap-1 items-center">
                           {charge > 5 && (subStage==='paper'?balloonPos.y>50:Math.abs(balloonPos.x-canX)<40) && <div className="flex gap-1 animate-bounce text-xs font-bold text-blue-500">Run Away! ‚Üì</div>}
                           <div className="flex gap-1">{Array.from({length: 5}).map((_,i)=><ChargeCircle key={i} type="pos" size="sm"/>)}</div>
                        </div>
                     )}
                  </div>
                </div>
              </div>
            )}
          </div>

          <div className="flex gap-2 mb-2 overflow-x-auto pb-2 w-full max-w-2xl">
            {['charge','paper','can','wall'].map(s => (
                <button key={s} onClick={() => setSubStage(s)} disabled={s !== 'charge' && charge < 5} className={`px-4 py-2 rounded-lg font-bold capitalize whitespace-nowrap ${subStage===s?'bg-purple-600 text-white':'bg-white text-purple-600 border border-purple-200'} ${s!=='charge'&&charge<5?'opacity-50':''}`}>{s}</button>
            ))}
          </div>

          <div className="relative w-full h-80 bg-slate-200 rounded-xl border-4 border-slate-300 overflow-hidden select-none touch-none shadow-inner cursor-none" onMouseMove={handleInteraction} onTouchMove={handleInteraction}>
             {subStage === 'charge' && (
                 <div className="absolute bottom-0 right-0 w-72 h-48 bg-orange-700 rounded-tl-[60px] border-t-4 border-l-4 border-orange-800 shadow-2xl overflow-hidden">
                     {/* Label for Sweater */}
                     <div className="absolute bottom-2 right-4 bg-white/30 text-white font-bold px-2 py-1 rounded rotate-[-5deg] pointer-events-none text-sm border border-white/50 shadow-sm backdrop-blur-sm">Wool Sweater</div>
                     <div className="absolute inset-0 flex flex-wrap content-center justify-center gap-4 p-6">
                        {Array.from({length: 15}).map((_, i) => (
                            <div key={i} className="relative w-8 h-8 flex items-center justify-center bg-orange-800/50 rounded-full">
                                <ChargeCircle type="pos" size="md" className="absolute opacity-50" />
                                {i < (15 - charge) && <ChargeCircle type="neg" size="md" className="absolute z-10 animate-pulse" />}
                            </div>
                        ))}
                     </div>
                 </div>
             )}
             {subStage === 'paper' && (
                 <div className="absolute bottom-10 left-0 w-full flex justify-center h-20">
                     {papers.map(p => (
                         <div key={p.id} className="absolute bg-white w-6 h-8 shadow-sm border border-gray-300 flex flex-col items-center justify-center" 
                              style={{ 
                                left: `${p.initialX}%`, 
                                bottom: p.lifted ? '10px' : '0px', 
                                transform: `rotate(${p.lifted ? (Math.random() > 0.5 ? -15 : 15) : p.clumpOffset * 2}deg) scale(${p.lifted ? 1.1 : 1}) translateY(${p.lifted ? -15 : 0}px)`, 
                                zIndex: p.lifted ? 50 : 1,
                                transition: 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)' 
                              }}>
                            <ChargeCircle type="pos" size="sm" className="mb-[-4px]" />
                            <ChargeCircle type="neg" size="sm" className={`transition-transform duration-300 ${p.lifted ? 'translate-y-4 opacity-50' : ''}`} />
                         </div>
                     ))}
                     <div className="absolute bottom-[-10px] w-full h-4 bg-gray-400"></div>
                 </div>
             )}
             {subStage === 'can' && (
                 <div className="absolute bottom-8 w-20 h-28 bg-gradient-to-r from-gray-300 via-gray-100 to-gray-300 border-t-4 border-b-4 border-gray-400 rounded-sm shadow-xl flex flex-col items-center justify-center overflow-hidden transition-all duration-300 ease-out" 
                      style={{ left: `${canX}%`, transform: 'translateX(-50%)' }}>
                     <div className="w-full h-full absolute inset-0 flex flex-col justify-center gap-2 items-center">
                        <div className="flex gap-1 opacity-60"><ChargeCircle type="pos" size="sm" /><ChargeCircle type="pos" size="sm" /></div>
                        <div className={`flex gap-1 transition-transform duration-500 ${charge > 5 && Math.abs(balloonPos.x - canX) < 40 ? 'translate-x-8' : ''}`}><ChargeCircle type="neg" size="sm" /><ChargeCircle type="neg" size="sm" /></div>
                     </div>
                 </div>
             )}
             {subStage === 'wall' && (
                <div className="absolute top-0 left-0 w-32 h-full bg-amber-100 border-r-4 border-amber-200 flex flex-col items-center justify-center overflow-hidden">
                    <div className="absolute inset-0 flex flex-col justify-around p-2">
                        {Array.from({length: 8}).map((_, r) => (
                            <div key={r} className="flex justify-around">
                                {Array.from({length: 3}).map((_, c) => (
                                    <div key={c} className="relative w-6 h-6 flex items-center justify-center">
                                        <span className="text-red-500 font-bold text-xs absolute">+</span>
                                        <span className={`text-blue-500 font-bold text-xs absolute transition-transform duration-500 ${charge > 5 && balloonPos.x < 30 ? 'translate-x-4 opacity-50' : ''}`}>-</span>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                    <div className="text-amber-800/20 font-bold text-4xl rotate-90 z-10 pointer-events-none">WALL</div>
                </div>
             )}

             <div className="absolute w-32 h-40 pointer-events-none z-50" style={{ left: `${subStage==='wall'&&isComplete?10:balloonPos.x}%`, top: `${subStage==='wall'&&isComplete?40:balloonPos.y}%`, transform: 'translate(-50%, -50%)' }}>
                 <div className="w-full h-full bg-purple-500 rounded-[50%_50%_50%_50%_/_40%_40%_60%_60%] shadow-xl flex items-center justify-center relative">
                     <div className="absolute bottom-[-8px] w-4 h-4 bg-purple-600 rounded-full"></div>
                     <div className="flex flex-wrap justify-center gap-1 px-4 content-center h-full pb-4">
                        {Array.from({length: charge}).map((_, i) => <ChargeCircle key={i} type="neg" size="sm" />)}
                     </div>
                 </div>
             </div>
             {flying.map(f => <div key={f.id} className="absolute bottom-10 right-10 flying-electron" style={{ '--tx': '-100px', '--ty': '-200px' }}><ChargeCircle type="neg" /></div>)}
          </div>
          <div className="mt-4 text-center">
             {subStage === 'charge' && charge >= 5 && <Button onClick={() => setSubStage('paper')} className="animate-bounce">Next &rarr;</Button>}
             {subStage === 'wall' && isComplete && <Button onClick={onComplete} className="bg-green-500 text-xl px-8 py-2 mt-4">Mission Complete &rarr;</Button>}
          </div>
        </div>
      );
    };

    // --- STAGE 6: Real Life ---
    const RealLifeLab = ({ onComplete, settings }) => {
        const [active, setActive] = useState(null);
        const list = [{id:1,i:'üå©Ô∏è',t:'Lightning',d:'Clouds rub together -> huge charge!'}, {id:2,i:'üö™',t:'Shock',d:'Rug rubbing steals electrons from you.'}, {id:3,i:'üëñ',t:'Dryer',d:'Clothes rubbing makes them stick.'}, {id:4,i:'üñ®Ô∏è',t:'Copier',d:'Static holds toner to paper.'}];
        return (
            <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
                <h2 className="text-2xl font-bold mb-4 text-purple-600">Mission 6: Real World</h2>
                <Sparkle message="Where do we see static electricity in the real world?" speak={settings.speak} />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                    {list.map(ex => (
                        <div key={ex.id} onClick={() => { setActive(ex.id); if(settings.sound) playSound('pop'); }} className={`p-6 rounded-xl border-4 cursor-pointer hover:scale-105 bg-white ${active===ex.id?'ring-4 ring-purple-400':''}`}>
                            <div className="text-5xl text-center">{ex.i}</div>
                            <h3 className="text-xl font-bold text-center">{ex.t}</h3>
                            {active===ex.id && <p className="text-gray-700 text-center mt-2 animate-fadeIn">{ex.d}</p>}
                        </div>
                    ))}
                </div>
                {active && <div className="mt-8"><Button onClick={onComplete} className="bg-purple-600 px-8 py-3">Take Quiz &rarr;</Button></div>}
            </div>
        )
    };

    // --- STAGE 7: Quiz ---
    const QuizLevel = ({ onComplete, settings }) => {
        const [q, setQ] = useState(0);
        const [feed, setFeed] = useState(false);
        const [ok, setOk] = useState(false);
        const [score, setScore] = useState(0);
        
        // Updated Quiz Questions: 5 full sentences with full phrase options
        const qs = [
            {
                q: "What is the electric charge of a single electron?",
                o: ["It has a Positive charge", "It has a Negative charge", "It has no charge (Neutral)"],
                a: 1, 
                r: "Electrons are the negatively charged particles that orbit the nucleus."
            }, 
            {
                q: "What occurs when two objects with the same charge are brought near each other?",
                o: ["They will attract each other", "They will repel or push away", "Nothing will happen"],
                a: 1, 
                r: "Like charges always repel each other, while opposite charges attract."
            }, 
            {
                q: "Which part of the atom contains the Protons and Neutrons?",
                o: ["They orbit in the outer shells", "They are inside the Nucleus", "They are floating in the air"],
                a: 1, 
                r: "The Nucleus is the dense center of the atom housing Protons and Neutrons."
            }, 
            {
                q: "How does the balloon become charged when rubbed on the sweater?",
                o: ["It gains electrons from the sweater", "It creates new protons", "The sweater melts onto it"],
                a: 0, 
                r: "Friction transfers electrons from the wool sweater to the balloon, giving it a negative charge."
            },
            {
                q: "Why does the negatively charged balloon stick to the neutral wall?",
                o: ["The wall becomes a magnet", "The balloon pushes wall electrons away, creating attraction", "The glue from the balloon holds it"],
                a: 1, 
                r: "The balloon repels electrons in the wall, creating a positive surface that attracts the negative balloon (polarization)."
            }
        ];

        const ans = (i) => {
            const isCor = i === qs[q].a;
            setOk(isCor); setFeed(true);
            if(isCor) { setScore(s=>s+1); if(settings.sound) playSound('success'); } else { if(settings.sound) playSound('fail'); }
        };
        const next = () => { setFeed(false); if(q<qs.length-1) setQ(q+1); else onComplete(score); };

        return (
            <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
                <h2 className="text-2xl font-bold mb-4 text-purple-600">Final Quiz</h2>
                <Sparkle 
                    message={feed ? (ok ? "Correct! " : "Oops! ") + qs[q].r : qs[q].q} 
                    emotion={feed ? (ok ? 'excited' : 'shocked') : 'happy'}
                    speak={settings.speak} 
                />
                <div className="bg-white rounded-xl shadow-lg p-8 w-full max-w-2xl border-2 border-purple-100 text-center">
                    <div className="text-gray-500 font-bold mb-2">Question {q+1} of {qs.length}</div>
                    <h3 className="text-2xl font-bold mb-6">{qs[q].q}</h3>
                    {!feed ? (
                        <div className="space-y-4">{qs[q].o.map((o,i)=><button key={i} onClick={()=>ans(i)} className="w-full p-4 rounded-lg bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 font-bold text-lg text-left">{o}</button>)}</div>
                    ) : (
                        <div className="animate-fadeIn">
                            <div className="text-6xl mb-4">{ok?'‚úÖ':'‚ùå'}</div>
                            <h3 className="text-2xl font-bold mb-2">{ok ? 'Correct!' : 'Oops, not quite!'}</h3>
                            <p className="text-gray-600 mb-6 text-lg px-4">{qs[q].r}</p>
                            <Button onClick={next} className="bg-purple-600">Next &rarr;</Button>
                        </div>
                    )}
                </div>
            </div>
        )
    };

    // --- STAGE 8: Lab Report (Wrap-Up Summary) ---
    const SummaryLevel = ({ onComplete, settings }) => {
        return (
            <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
                <h2 className="text-3xl font-bold mb-6 text-purple-800">Lab Report Summary</h2>
                <Sparkle message="Excellent work Scientist! Here is what we discovered today." speak={settings.speak} />
                
                <div className="bg-white p-8 rounded-xl shadow-xl border-l-8 border-purple-500 w-full max-w-2xl space-y-6">
                    <div className="flex items-center gap-4">
                        <div className="text-4xl">‚öõÔ∏è</div>
                        <div>
                            <h3 className="font-bold text-xl">The Atom</h3>
                            <p className="text-gray-600">Protons (+) and Neutrons (0) are stuck in the center. Electrons (-) fly around the outside.</p>
                        </div>
                    </div>
                    <div className="w-full h-px bg-gray-200"></div>
                    <div className="flex items-center gap-4">
                        <div className="text-4xl">üß≤</div>
                        <div>
                            <h3 className="font-bold text-xl">The Rules of Charge</h3>
                            <p className="text-gray-600">Opposites Attract (+ likes -). Likes Repel (+ hates +).</p>
                        </div>
                    </div>
                    <div className="w-full h-px bg-gray-200"></div>
                    <div className="flex items-center gap-4">
                        <div className="text-4xl">üéà</div>
                        <div>
                            <h3 className="font-bold text-xl">Static Electricity</h3>
                            <p className="text-gray-600">Rubbing things together (Friction) steals electrons. The object that gains electrons becomes negative!</p>
                        </div>
                    </div>
                </div>

                <div className="mt-8">
                    <Button onClick={onComplete} className="bg-green-600 text-2xl px-10 py-4 hover:bg-green-700 shadow-xl animate-bounce">
                        Get Certificate üéì
                    </Button>
                </div>
            </div>
        )
    }

    // --- STAGE 9: Certificate ---
    const WrapUp = ({ settings }) => {
        useEffect(() => { if(settings.sound) playSound('win'); }, []);
        return (
            <div className="flex flex-col items-center justify-center min-h-[60vh] text-center p-8 animate-fadeIn relative overflow-hidden">
                 {Array.from({length: 50}).map((_,i) => <div key={i} className="confetti" style={{left: `${Math.random()*100}%`, animationDuration: `${2+Math.random()*3}s`, backgroundColor: ['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)]}}></div>)}
                <div className="text-8xl mb-6 animate-bounce">üéì</div>
                <h1 className="text-4xl md:text-6xl font-bold text-purple-800 mb-4 font-comic">Congratulations!</h1>
                <h2 className="text-2xl md:text-3xl font-bold text-green-600 mb-8">You are a Certified Sparkle Scientist!</h2>
                <div className="bg-white p-10 rounded-xl shadow-2xl border-8 border-yellow-400 max-w-xl rotate-1 transform hover:rotate-0 transition-transform">
                    <p className="text-xl mb-4">LaSallian Scientist Certification</p>
                    <div className="border-b-4 border-black w-full h-8 mb-4"></div>
                    <p className="text-lg text-gray-600">Awarded for mastering the secrets of Static Electricity.</p>
                    <div className="flex justify-between items-end mt-12">
                         <div className="text-center"><div className="font-script text-2xl text-purple-600 font-cursive">Sparkle</div><div className="border-t border-gray-400 text-sm">Lab Director</div></div>
                         <div className="text-4xl">‚ö°</div>
                    </div>
                </div>
                <div className="mt-12"><Button onClick={() => window.location.reload()} className="bg-gray-500 hover:bg-gray-600">Restart Lab</Button></div>
            </div>
        )
    };

    // --- MAIN APP ---
    const App = () => {
        const [stage, setStage] = useState(0);
        const [settings, setSettings] = useState({ sound: true, speak: true, music: true });
        const [showInfo, setShowInfo] = useState(false);
        const musicRef = useRef(null);
        const noteIndexRef = useRef(0);

        const nextStage = () => setStage(s => s + 1);
        const toggleMusic = () => setSettings(p => ({...p, music: !p.music}));

        useEffect(() => {
            if (settings.music && stage > 0) { 
                if (!musicRef.current) {
                    musicRef.current = setInterval(() => { playMusicNote(noteIndexRef.current); noteIndexRef.current++; }, 800);
                }
            } else {
                if (musicRef.current) { clearInterval(musicRef.current); musicRef.current = null; }
            }
            return () => { if(musicRef.current) clearInterval(musicRef.current); };
        }, [settings.music, stage]);

        const startApp = () => { initAudio(); nextStage(); }

        const labels = ['Intro', 'Atoms', 'Shells', 'Forces', 'Comb', 'Balloon', 'Real Life', 'Quiz', 'Summary', 'Done'];

        return (
            <div className="min-h-screen pb-10">
               {showInfo && (
                   <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 animate-fadeIn">
                       <div className="bg-white rounded-xl p-6 max-w-sm w-full text-center shadow-2xl relative border-4 border-purple-200">
                           <button onClick={() => setShowInfo(false)} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600 font-bold text-xl">‚úï</button>
                           <div className="text-4xl mb-2">üë®‚Äçüè´</div>
                           <h3 className="text-xl font-bold text-purple-600 mb-2">Credits</h3>
                           <p className="text-gray-800 font-medium">Developed by Sir Angelo Medez, LPT</p>
                           <p className="text-gray-600 text-sm mt-1">for Grade 5 Science via Gemini Canvas</p>
                       </div>
                   </div>
               )}

               <div className="bg-white shadow-sm p-4 sticky top-0 z-40 flex justify-between items-center mb-4">
                   <h1 className="text-xl md:text-2xl font-bold text-purple-600 flex items-center gap-2"><span className="text-3xl">‚ö°</span> Sparkle's Static Lab</h1>
                   <div className="flex gap-2">
                       <button onClick={() => setShowInfo(true)} className="p-2 rounded-full bg-yellow-100 text-yellow-600">‚ÑπÔ∏è</button>
                       <button onClick={toggleMusic} className={`p-2 rounded-full ${settings.music?'bg-purple-100 text-purple-600':'bg-gray-100 text-gray-400'}`}>{settings.music?'üéµ':'üîá'}</button>
                       <button onClick={()=>setSettings(s=>({...s, speak:!s.speak}))} className={`p-2 rounded-full ${settings.speak?'bg-blue-100 text-blue-600':'bg-gray-100 text-gray-400'}`}>{settings.speak?'üó£Ô∏è':'üò∂'}</button>
                       <button onClick={()=>setSettings(s=>({...s, sound:!s.sound}))} className={`p-2 rounded-full ${settings.sound?'bg-green-100 text-green-600':'bg-gray-100 text-gray-400'}`}>{settings.sound?'üîä':'üîá'}</button>
                   </div>
               </div>

               {stage > 0 && stage < 9 && (
                   <div className="w-full max-w-4xl mx-auto px-4 mb-6">
                       <div className="flex justify-between mb-2">
                           {labels.slice(1, -1).map((label, idx) => (
                               <div key={idx} className={`text-[10px] md:text-xs font-bold ${stage >= idx + 1 ? 'text-purple-600' : 'text-gray-300'}`}>{label}</div>
                           ))}
                       </div>
                       <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                           <div className="h-full bg-purple-500 transition-all duration-500" style={{ width: `${((stage - 1) / 7) * 100}%` }}></div>
                       </div>
                   </div>
               )}

               <main className="container mx-auto">
                   {stage === 0 && <IntroScreen onComplete={startApp} settings={settings} />}
                   {stage === 1 && <AtomBuilder onComplete={nextStage} settings={settings} />}
                   {stage === 2 && <ElectronShellLevel onComplete={nextStage} settings={settings} />}
                   {stage === 3 && <ChargesLevel onComplete={nextStage} settings={settings} />}
                   {stage === 4 && <CombLab onComplete={nextStage} settings={settings} />}
                   {stage === 5 && <BalloonLab onComplete={nextStage} settings={settings} />}
                   {stage === 6 && <RealLifeLab onComplete={nextStage} settings={settings} />}
                   {stage === 7 && <QuizLevel onComplete={nextStage} settings={settings} />}
                   {stage === 8 && <SummaryLevel onComplete={nextStage} settings={settings} />}
                   {stage === 9 && <WrapUp settings={settings} />}
               </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
