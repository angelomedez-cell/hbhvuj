<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ms. Sparkle's Static Lab</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Global Styles */
    html, body {
      height: 100%;
      overflow: hidden; 
    }
    body { 
      font-family: 'Comic Neue', 'Comic Sans MS', sans-serif; 
      background-color: #f0f9ff; 
      touch-action: pan-y;
    }
    #root { height: 100%; display: flex; flex-direction: column; }
    .sim-container { touch-action: none; }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-6px); }
      100% { transform: translateY(0px); }
    }
    .floating { animation: float 3s ease-in-out infinite; }
    
    .particle { transition: all 0.5s ease-out; }
    .animate-spin-slow { animation: spin 10s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Physics & Interaction Classes */
    .draggable { cursor: grab; touch-action: none; }
    .draggable:active { cursor: grabbing; }
    
    .no-lag { transition: none; }
    .smooth-catchup { transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }

    .flying-electron {
      animation: flyToTarget 0.6s ease-out forwards;
    }
    @keyframes flyToTarget {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
    }

    .speech-bubble::before {
      content: '';
      position: absolute;
      left: -12px;
      top: 24px;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 12px solid #FCD34D; 
    }

    @keyframes pointMove {
      0% { transform: translateX(0); opacity: 0.5; }
      50% { transform: translateX(10px); opacity: 1; }
      100% { transform: translateX(0); opacity: 0.5; }
    }
    .arrow-anim { animation: pointMove 1.5s infinite; }

    /* Custom Scrollbar for nicer UI */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Confetti Animation */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #f00;
      animation: fall linear forwards;
    }
    @keyframes fall {
      to { transform: translateY(100vh) rotate(720deg); }
    }
    
    .bubble-point-right::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 100%; /* To the right of the bubble */
        transform: translateY(-50%);
        border-width: 5px;
        border-style: solid;
        border-color: transparent transparent transparent #fde047; /* Pointing right */
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // --- Audio Engine (Web Audio API) ---
    let audioCtx = null;

    const initAudio = () => {
        try {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        } catch (e) {
            console.warn("Audio Context failed to initialize", e);
        }
    };

    // -- Background Music Notes --
    const melody = [
      261.63, 293.66, 329.63, 392.00, 440.00, 392.00, 329.63, 293.66,
      261.63, 261.63, 329.63, 329.63, 293.66, 293.66, 261.63, 261.63
    ];

    const playMusicNote = (index) => {
        if (!audioCtx || audioCtx.state === 'suspended') return;
        
        try {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            const freq = melody[index % melody.length];
            
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq / 2, now); 
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.05, now + 0.1); 
            gainNode.gain.linearRampToValueAtTime(0.03, now + 0.5); 
            gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
            
            osc.start(now);
            osc.stop(now + 0.8);
        } catch(e) {}
    };

    const playSound = (type) => {
      initAudio();
      if (!audioCtx) return;

      try {
          const osc = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          
          osc.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          const now = audioCtx.currentTime;

          switch (type) {
            case 'pop':
              osc.type = 'sine';
              osc.frequency.setValueAtTime(800, now);
              osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
              gainNode.gain.setValueAtTime(0.1, now);
              gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
              osc.start(now);
              osc.stop(now + 0.1);
              break;
            case 'blip': 
              osc.type = 'square';
              osc.frequency.setValueAtTime(400, now);
              osc.frequency.setValueAtTime(600, now + 0.05);
              gainNode.gain.setValueAtTime(0.03, now);
              gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
              osc.start(now);
              osc.stop(now + 0.1);
              break;
            case 'zap':
              osc.type = 'sawtooth';
              osc.frequency.setValueAtTime(500, now);
              osc.frequency.linearRampToValueAtTime(100, now + 0.2);
              gainNode.gain.setValueAtTime(0.1, now);
              gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
              osc.start(now);
              osc.stop(now + 0.2);
              break;
            case 'rub':
              const bufferSize = audioCtx.sampleRate * 0.1;
              const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
              const data = buffer.getChannelData(0);
              for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
              const noise = audioCtx.createBufferSource();
              noise.buffer = buffer;
              const noiseGain = audioCtx.createGain();
              noiseGain.gain.setValueAtTime(0.05, now);
              noiseGain.gain.linearRampToValueAtTime(0, now + 0.1);
              noise.connect(noiseGain);
              noiseGain.connect(audioCtx.destination);
              noise.start(now);
              break;
            case 'roll': 
              osc.type = 'square';
              osc.frequency.setValueAtTime(100, now);
              osc.frequency.exponentialRampToValueAtTime(50, now + 0.15);
              gainNode.gain.setValueAtTime(0.05, now);
              gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
              osc.start(now);
              osc.stop(now + 0.15);
              break;
            case 'swish': 
              osc.type = 'triangle';
              osc.frequency.setValueAtTime(200, now);
              osc.frequency.linearRampToValueAtTime(400, now + 0.2);
              gainNode.gain.setValueAtTime(0.05, now);
              gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
              osc.start(now);
              osc.stop(now + 0.2);
              break;
            case 'thump':
               osc.type = 'sine';
               osc.frequency.setValueAtTime(100, now);
               osc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
               gainNode.gain.setValueAtTime(0.2, now);
               gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
               osc.start(now);
               osc.stop(now + 0.1);
               break;
            case 'success':
              osc.type = 'sine';
              osc.frequency.setValueAtTime(440, now);
              osc.frequency.setValueAtTime(554, now + 0.1); 
              osc.frequency.setValueAtTime(659, now + 0.2); 
              gainNode.gain.setValueAtTime(0.1, now);
              gainNode.gain.linearRampToValueAtTime(0, now + 0.4);
              osc.start(now);
              osc.stop(now + 0.4);
              break;
            case 'win':
              const notes = [523.25, 659.25, 783.99, 1046.50];
              notes.forEach((f, i) => {
                 const osc2 = audioCtx.createOscillator();
                 const gn2 = audioCtx.createGain();
                 osc2.connect(gn2);
                 gn2.connect(audioCtx.destination);
                 osc2.type = 'triangle';
                 osc2.frequency.setValueAtTime(f, now + i*0.1);
                 gn2.gain.setValueAtTime(0.1, now + i*0.1);
                 gn2.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.4);
                 osc2.start(now + i*0.1);
                 osc2.stop(now + i*0.1 + 0.4);
              });
              break;
            case 'fail':
              osc.type = 'sawtooth';
              osc.frequency.setValueAtTime(150, now);
              osc.frequency.linearRampToValueAtTime(100, now + 0.3);
              gainNode.gain.setValueAtTime(0.1, now);
              gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
              osc.start(now);
              osc.stop(now + 0.3);
              break;
          }
      } catch(e) {}
    };

    // --- Components ---

    const Button = ({ onClick, children, disabled, className = "" }) => (
      <button 
        onClick={(e) => { playSound('pop'); onClick(e); }} 
        disabled={disabled}
        className={`px-6 py-2 rounded-full font-bold shadow-lg transform transition active:scale-95 ${disabled ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-400 text-white'} ${className}`}
      >
        {children}
      </button>
    );

    const GuideArrow = ({ text, className = "", direction = "right" }) => (
      <div className={`absolute pointer-events-none z-40 flex items-center ${className} ${direction === "left" ? "flex-row-reverse" : ""}`}>
        <span className="bg-white/90 px-2 py-1 rounded text-xs font-bold text-blue-600 shadow-sm whitespace-nowrap">{text}</span>
        <div className={`text-4xl text-blue-500 font-bold arrow-anim ${direction === "left" ? "rotate-180" : ""}`}>&rarr;</div>
      </div>
    );

    // Reusable Charge Bubble Component for Consistency
    const ChargeCircle = ({ type, size = "md", animate = false, className="", style={} }) => {
        const sizeClass = size === "sm" ? "w-4 h-4 text-[10px]" : (size === "lg" ? "w-8 h-8 text-xl" : "w-6 h-6 text-sm");
        const colorClass = type === 'pos' ? "bg-red-500 text-white" : "bg-blue-500 text-white"; 
        const sign = type === 'pos' ? '+' : '-';
        
        return (
            <div style={style} className={`${sizeClass} rounded-full flex items-center justify-center font-bold shadow-sm border border-white/30 select-none ${colorClass} ${animate ? 'animate-pulse' : ''} ${className}`}>
                {sign}
            </div>
        )
    };

    const Sparkle = ({ message, emotion = 'happy', speak = true }) => {
      const [isSpeaking, setIsSpeaking] = useState(false);

      useEffect(() => {
        if (!speak || !window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        
        const spokenText = message
            .replace(/^\d+\.\s*/gm, '') 
            .replace(/\(0\)/g, '') 
            .replace(/\//g, ' ') 
            .replace(/[\*\_\-\+]/g, ' '); 

        const utterance = new SpeechSynthesisUtterance(spokenText);
        utterance.lang = 'en-US';
        utterance.pitch = 1.2; 
        utterance.rate = 1.0; 
        
        const voices = window.speechSynthesis.getVoices();
        if(voices.length > 0) {
            const preferredVoice = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
            if (preferredVoice) utterance.voice = preferredVoice;
        }

        utterance.onstart = () => setIsSpeaking(true);
        utterance.onend = () => setIsSpeaking(false);
        utterance.onerror = () => setIsSpeaking(false);
        
        try {
            window.speechSynthesis.speak(utterance);
        } catch(e) {}
        
        return () => window.speechSynthesis.cancel();
      }, [message, speak]);

      return (
        <div className="flex flex-col items-center flex-shrink-0 max-w-[200px] md:max-w-xs animate-fadeIn z-50 relative">
          <div className="flex-shrink-0 flex flex-col items-center">
            <div className="text-6xl md:text-8xl relative floating">
              <span role="img" aria-label="Ms. Sparkle" className="inline-block origin-bottom" style={{ filter: emotion === 'shocked' ? 'invert(1)' : 'none' }}>
                {emotion === 'shocked' ? 'üò≤' : 'üë©'}
              </span>
              <div className="absolute -top-2 -right-4 text-4xl md:text-5xl text-yellow-600 font-bold z-20 drop-shadow-md">‚ö°</div>
              {isSpeaking && <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-full h-1 bg-yellow-400/50 blur-sm animate-pulse"></div>}
            </div>
            <div className="font-bold text-purple-800 mt-2 bg-purple-200 px-3 py-0.5 rounded-full text-sm border border-purple-400 shadow-sm">Ms. Sparkle</div>
          </div>
          <div className="bg-white border-l-8 border-yellow-300 p-4 rounded-r-xl rounded-bl-xl shadow-md w-full mt-4 transition-all">
            <div className="text-gray-800 font-medium leading-relaxed text-sm md:text-base whitespace-pre-line">{message}</div>
          </div>
        </div>
      );
    };

    // --- JOURNAL SIDEBAR ---
    const JournalSidebar = ({ stage, isOpen, onClose }) => {
        const otherSims = [
            { title: "Simple Circuits", icon: "üîã" },
            { title: "Open & Closed", icon: "üîå" },
            { title: "Series & Parallel", icon: "üí°" },
            { title: "Insulators and Conductors", icon: "üóùÔ∏è" }
        ];

        const concepts = [
            { s: 2, text: "Atoms: Protons/Neutrons inside, Electrons outside." },
            { s: 3, text: "Electrons are loose and can move!" },
            { s: 4, text: "Opposites Attract (+/-). Likes Repel (+/+)." },
            { s: 5, text: "Friction transfers electrons to charge things." },
            { s: 6, text: "Charged objects attract neutral ones (Polarization)." },
            { s: 7, text: "Static electricity is everywhere in real life!" }
        ];
        const visibleNotes = concepts.filter(c => stage >= c.s);

        return (
            <>
                {isOpen && <div className="fixed inset-0 bg-black/20 z-[60]" onClick={onClose}></div>}
                <div className={`fixed top-0 right-0 h-full w-80 bg-[#f8fafc] shadow-2xl border-l-4 border-purple-200 transform transition-transform duration-300 z-[70] flex flex-col ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                    <div className="p-4 bg-purple-100 border-b border-purple-200 flex justify-between items-center">
                        <h3 className="font-bold text-purple-800 text-lg">My Science Journal üìì</h3>
                        <button onClick={onClose} className="text-purple-800 hover:text-purple-600 font-bold text-xl">‚úï</button>
                    </div>
                    <div className="p-6 flex-1 overflow-y-auto">
                        <div className="space-y-6">
                            {stage === 0 ? (
                                <div className="space-y-6">
                                    <p className="text-gray-600 text-sm italic">Complete experiments to unlock your journal notes!</p>
                                    <div>
                                        <h4 className="font-bold text-gray-500 mb-3 text-sm uppercase tracking-wide">Coming Soon</h4>
                                        <div className="grid grid-cols-2 gap-3">
                                            {otherSims.map((sim, idx) => (
                                                <div key={idx} className="bg-gray-200 rounded-lg p-3 flex flex-col items-center justify-center text-gray-500 relative h-24 border border-gray-300">
                                                    <div className="absolute top-1 right-1 text-xs opacity-50">üîí</div>
                                                    <div className="text-2xl grayscale mb-2 opacity-50">{sim.icon}</div>
                                                    <span className="text-[10px] font-bold text-center leading-tight">{sim.title}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <p className="text-xs text-gray-400 mt-2 text-center">Simulations by Sir Angelo Medez, LPT</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {visibleNotes.length === 0 && (
                                        <div className="text-center py-10 opacity-50">
                                            <div className="text-4xl mb-2">üß™</div>
                                            <p>Start experimenting to collect notes!</p>
                                        </div>
                                    )}
                                    {visibleNotes.map((note, idx) => (
                                        <div key={idx} className="bg-yellow-100 text-yellow-900 p-4 shadow-md border-l-4 border-yellow-400 rounded-r-lg font-comic transform rotate-1 transition-transform hover:rotate-0 hover:scale-105 relative">
                                            <div className="absolute -top-3 -left-2 text-2xl text-red-400">üìå</div>
                                            {note.text}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </>
        );
    };

    // --- STAGE 0: Intro ---
    const IntroScreen = ({ onComplete, settings }) => {
        const spokenWelcome = "Welcome LaSallian Young Scientists! I'm Ms. Sparkle. Check out our checklist of experiments below!";
        const otherSims = [
            { title: "Simple Circuits", icon: "üîã" },
            { title: "Open & Closed", icon: "üîå" },
            { title: "Series & Parallel", icon: "üí°" },
            { title: "Insulators and Conductors", icon: "üóùÔ∏è" }
        ];

        return (
            <div className="flex flex-col h-full w-full">
                <div className="flex-1 flex flex-col md:flex-row items-center justify-center w-full max-w-7xl mx-auto p-4 gap-8">
                    <div className="flex-1 flex justify-center md:justify-end">
                        <Sparkle message={spokenWelcome} speak={settings.speak} />
                    </div>
                    
                    <div className="flex-1 bg-white/80 p-6 rounded-xl shadow-lg border-2 border-purple-200 max-w-lg w-full">
                        <h2 className="text-2xl font-bold text-purple-800 mb-4 font-comic text-center">Lab Checklist üìã</h2>
                        <ul className="text-left text-gray-700 font-medium space-y-2 mb-6 ml-4">
                            <li>1. Build an Atom ‚öõÔ∏è</li>
                            <li>2. Explore Electron Shells üîµ</li>
                            <li>3. Master Attraction & Repulsion üß≤</li>
                            <li>4. Charge a Comb üíá‚Äç‚ôÄÔ∏è</li>
                            <li>5. The Balloon Experiments üéà</li>
                            <li>6. Everyday Life Examples üå©Ô∏è</li>
                        </ul>
                        <div className="text-center">
                            <Button onClick={onComplete} className="text-xl md:text-2xl px-8 md:px-10 py-3 md:py-4 bg-green-500 hover:bg-green-600 transform hover:scale-105 transition-all shadow-xl">
                                Enter the Lab üöÄ
                            </Button>
                            <p className="text-gray-500 text-xs md:text-sm mt-4 italic">Clicking start enables the lab equipment sound system.</p>
                        </div>
                    </div>
                </div>

                {/* Coming Soon Footer */}
                <div className="bg-gray-200 w-full p-3 border-t-4 border-gray-300 shrink-0">
                    <h3 className="text-center font-bold text-gray-500 mb-2 text-xs md:text-sm">Coming Soon: More Simulations from Sir Angelo Medez, LPT</h3>
                    <div className="grid grid-cols-4 gap-3 max-w-4xl mx-auto w-full px-4">
                        {otherSims.map((sim, idx) => (
                            <div key={idx} className="bg-gray-300 rounded-lg p-2 flex flex-col items-center justify-center text-gray-500 relative overflow-hidden h-16 md:h-20 shadow-inner border border-gray-400/50 opacity-70">
                                <div className="absolute top-1 right-1 text-[10px] opacity-50">üîí</div>
                                <div className="text-xl grayscale mb-1 opacity-50">{sim.icon}</div>
                                <span className="text-[10px] font-bold text-center leading-tight hidden md:block">{sim.title}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        )
    };

    // --- STAGE 1: Atom Builder ---
    const AtomBuilder = ({ onComplete, settings }) => {
      const [protons, setProtons] = useState(0);
      const [neutrons, setNeutrons] = useState(0);
      const [electrons, setElectrons] = useState(0);
      
      const elements = ["Vacuum", "Hydrogen", "Helium", "Lithium", "Beryllium", "Boron", "Carbon"];
      const elementName = elements[protons] || `Element ${protons}`;
      const mass = protons + neutrons;
      const netCharge = protons - electrons;
      
      let isStable = true;
      if (protons > 0) {
          const ratio = neutrons / protons;
          if (protons === 1) isStable = (neutrons === 0 || neutrons === 1 || neutrons === 2);
          else if (protons === 2) isStable = (neutrons === 1 || neutrons === 2);
          else if (protons === 3) isStable = (neutrons === 3 || neutrons === 4);
          else if (protons === 4) isStable = (neutrons === 5);
          else isStable = (ratio >= 1 && ratio <= 1.2);
      }
      
      const isComplete = protons === 3 && neutrons === 4 && electrons === 3;
      
      const getPos = (index) => {
        const angle = index * 2.39996; 
        const r = 10 * Math.sqrt(index); 
        return { x: r * Math.cos(angle), y: r * Math.sin(angle) };
      };

      const getFeedback = () => {
          if (isComplete) return "Perfect! That's a stable Lithium atom.";
          if (protons === 0) return "Mission 1: Build a Lithium Atom.\nStart by adding 3 Protons (+).";
          if (protons < 3) return `This is ${elementName}. Add more Protons to make Lithium (3).`;
          if (protons > 3) return `Too many! ${elementName} is not Lithium. Reduce Protons to 3.`;
          
          if (neutrons < 4) return "Good job finding Lithium! Now stabilize the nucleus. Add Neutrons (0) until you have 4.";
          if (neutrons > 4) return "Unstable nucleus! Too many Neutrons. Remove some to get 4.";

          if (electrons < 3) return "Nucleus is stable! Now balance the charge. Add 3 Electrons (-) to the shells.";
          if (electrons > 3) return "Negative Ion detected! Too many Electrons. Remove some to get 3.";

          return "Adjust particles to match: 3 Protons, 4 Neutrons, 3 Electrons.";
      };

      return (
        <div className="flex flex-col md:flex-row items-center justify-center w-full h-full max-w-7xl mx-auto p-2 gap-4 relative">
          <div className="flex-1 flex flex-col items-center md:items-start text-center md:text-left space-y-4 max-w-sm">
             <h2 className="text-2xl font-bold text-purple-600">Mission 1: Inside the Atom</h2>
             <Sparkle message={getFeedback()} emotion={isComplete ? 'excited' : (!isStable ? 'shocked' : 'happy')} speak={settings.speak} />
             
             {protons > 0 && (
                 <div className="w-full bg-white p-3 rounded-xl border-2 border-purple-100 shadow-md flex flex-col gap-2">
                     <div className="text-center font-bold text-xl text-purple-800">{elementName}</div>
                     <div className="flex justify-between text-sm">
                         <span className="font-bold text-gray-600">Mass: {mass}</span>
                         <span className={`font-bold ${netCharge === 0 ? 'text-green-600' : 'text-blue-600'}`}>Charge: {netCharge > 0 ? '+' : ''}{netCharge}</span>
                     </div>
                     <div className={`text-center text-xs font-bold py-1 rounded ${isStable ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600 animate-pulse'}`}>
                         {isStable ? (netCharge === 0 ? "Stable Neutral Atom" : "Stable Ion") : "Unstable Nucleus"}
                     </div>
                 </div>
             )}
          </div>

          <div className="flex-1 flex flex-col items-center justify-center w-full">
              <div className="relative w-full max-w-md aspect-square bg-gray-900 rounded-full flex items-center justify-center mb-4 overflow-hidden ring-4 ring-gray-200 shadow-xl">
                <div className="absolute w-[80%] h-[80%] border-2 border-dashed border-gray-600 rounded-full animate-spin-slow" style={{animationDuration: '10s'}}></div>
                <div className="absolute w-[60%] h-[60%] border-2 border-dashed border-gray-600 rounded-full animate-spin-slow" style={{animationDuration: '5s'}}></div>
                
                <div className="absolute w-24 h-24 flex items-center justify-center z-10 transition-all duration-300">
                  {Array.from({ length: protons }).map((_, i) => {
                    const pos = getPos(i);
                    return <ChargeCircle key={`p-${i}`} type="pos" className="absolute" style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }} />;
                  })}
                  {Array.from({ length: neutrons }).map((_, i) => {
                    const pos = getPos(protons + i);
                    return <div key={`n-${i}`} className="absolute w-6 h-6 bg-gray-400 rounded-full border border-gray-300" style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }}></div>;
                  })}
                </div>

                {Array.from({ length: electrons }).map((_, i) => {
                  const angle = (i / electrons) * 2 * Math.PI;
                  const radius = 100 + (i % 2) * 30;
                  const x = Math.cos(angle) * radius;
                  const y = Math.sin(angle) * radius;
                  return <ChargeCircle key={`e-${i}`} type="neg" className="absolute shadow-glow z-20" style={{ transform: `translate(${x}px, ${y}px)` }} />;
                })}
              </div>

              <div className="grid grid-cols-3 gap-4 w-full max-w-md">
                {[{l:'Protons (+)', c:protons, s:setProtons, col:'red'}, {l:'Neutrons (0)', c:neutrons, s:setNeutrons, col:'gray'}, {l:'Electrons (-)', c:electrons, s:setElectrons, col:'yellow'}].map((item, idx) => (
                  <div key={idx} className="flex flex-col items-center bg-white p-2 rounded-lg shadow">
                    <span className={`font-bold text-${item.col}-600 mb-1 text-sm`}>{item.l}</span>
                    <div className="flex gap-2 items-center">
                      <Button onClick={() => item.s(Math.max(0, item.c - 1))} className={`px-2 py-1 bg-${item.col}-200 text-black hover:bg-${item.col}-300`}>-</Button>
                      <span className="text-xl font-mono w-6 text-center">{item.c}</span>
                      <Button onClick={() => item.s(item.c + 1)} className={`px-2 py-1 bg-${item.col}-500 hover:bg-${item.col}-600`}>+</Button>
                    </div>
                  </div>
                ))}
              </div>
          </div>

          {isComplete && (
            <div className="absolute bottom-6 right-6 animate-bounce z-50">
              <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3 shadow-2xl border-2 border-white">Next Lab &rarr;</Button>
            </div>
          )}
        </div>
      );
    };

    // --- STAGE 2: Electron Shells ---
    const ElectronShellLevel = ({ onComplete, settings }) => {
      const [knocked, setKnocked] = useState(false);
      return (
        <div className="flex flex-col md:flex-row items-center justify-center w-full h-full max-w-7xl mx-auto p-2 gap-8 relative">
          <div className="flex-1 flex flex-col items-center md:items-start text-center md:text-left space-y-4 max-w-sm">
             <h2 className="text-2xl font-bold text-purple-600">Mission 2: Why do they move?</h2>
             <Sparkle message={knocked ? "See that? The nucleus holds tight, but that outer electron is loose!" : "The Nucleus is protected deep inside. But look at the Outside Shell... tap that electron!"} emotion={knocked ? 'excited' : 'happy'} speak={settings.speak} />
          </div>

          <div className="flex-1 flex justify-center w-full">
              <div className="relative w-full max-w-lg flex-1 min-h-[300px] bg-gray-900 rounded-xl flex items-center justify-center overflow-hidden border-4 border-gray-700">
                <div className="relative w-64 h-64 flex items-center justify-center">
                  <div className="absolute w-32 h-32 bg-gray-800 rounded-full flex flex-col items-center justify-center z-10 border-4 border-gray-600 gap-2">
                     <div className="flex gap-1"><ChargeCircle type="pos"/><ChargeCircle type="pos"/></div>
                     <div className="text-[10px] text-gray-300 font-bold">Nucleus</div>
                  </div>
                  <div className="absolute inset-0 border-2 border-dashed border-gray-500 rounded-full"></div>
                  
                  {!knocked && (
                      <GuideArrow 
                        text="Tap me!" 
                        className="top-[35%] right-2" 
                        direction="right" 
                      />
                  )}

                  <div 
                    onClick={() => { setKnocked(true); if(settings.sound) playSound('zap'); }}
                    className={`absolute cursor-pointer transition-transform z-20 ${knocked ? 'flying-electron' : 'animate-bounce'}`}
                    style={{ top: '50%', right: '-1.5rem', marginTop: '-1.5rem', '--tx': '200px', '--ty': '-200px' }}
                  >
                    <ChargeCircle type="neg" size="lg" />
                  </div>
                </div>
              </div>
          </div>
          
          {knocked && (
            <div className="absolute bottom-6 right-6 animate-bounce z-50">
              <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3 shadow-2xl border-2 border-white">Next &rarr;</Button>
            </div>
          )}
        </div>
      );
    };

    // --- STAGE 3: Charges ---
    const ChargesLevel = ({ onComplete, settings }) => {
      const [chargeL, setChargeL] = useState('pos');
      const [chargeR, setChargeR] = useState('pos');
      const [animating, setAnimating] = useState(false);
      const [tested, setTested] = useState(false);
      const [completedTypes, setCompletedTypes] = useState({ attract: false, repel: false });

      const isAttract = chargeL !== chargeR;
      const isRepel = chargeL === chargeR;

      const handleTest = () => {
        setAnimating(true);
        if(settings.sound) playSound(isAttract ? 'swish' : 'zap');
        setTimeout(() => { 
            setAnimating(false); 
            setTested(true);
            setCompletedTypes(prev => ({ ...prev, [isAttract ? 'attract' : 'repel']: true }));
        }, 1000);
      };

      useEffect(() => { setTested(false); setAnimating(false); }, [chargeL, chargeR]);

      const allDone = completedTypes.attract && completedTypes.repel;

      const msg = tested 
        ? (isAttract ? "Correct! Opposites Attract. Positive and Negative pull together." : "Correct! Like charges Repel. Two of the same charge push away.") 
        : (allDone ? "You've mastered both! Ready to move on." : "Set the charges and hit Test. Try to find both Attraction and Repulsion!");

      const nextPrompt = tested && !allDone 
          ? (completedTypes.attract ? "Good! Now try to make them REPEL." : "Good! Now try to make them ATTRACT.")
          : "";

      return (
        <div className="flex flex-col md:flex-row items-center justify-center w-full h-full max-w-7xl mx-auto p-2 gap-8 relative">
          <div className="flex-1 flex flex-col items-center md:items-start text-center md:text-left space-y-4 max-w-sm">
             <h2 className="text-2xl font-bold text-purple-600">Mission 3: Attraction & Repulsion</h2>
             <Sparkle message={msg + (nextPrompt ? "\n\n" + nextPrompt : "")} speak={settings.speak} />
          </div>

          <div className="flex-1 flex flex-col items-center w-full">
              <div className="relative w-full max-w-lg flex-1 min-h-[300px] bg-gray-100 rounded-xl border-2 border-gray-300 flex items-center justify-center gap-32 overflow-hidden mb-6">
                
                {/* Left Charge Container */}
                <div className={`relative transition-all duration-700 ${animating || tested ? (isAttract ? 'translate-x-[64px]' : '-translate-x-[60px]') : ''}`}>
                    <ChargeCircle type={chargeL} size="lg" className="w-20 h-20 text-4xl shadow-xl z-20 relative" />
                    {/* Force Arrow Left */}
                    {tested && (
                        <div className={`absolute top-1/2 -translate-y-1/2 text-5xl font-bold animate-pulse z-10 ${isAttract ? 'right-[-50px] text-green-500' : 'left-[-50px] text-red-500'}`}>
                            {isAttract ? '‚Üí' : '‚Üê'}
                        </div>
                    )}
                </div>

                {/* Right Charge Container */}
                <div className={`relative transition-all duration-700 ${animating || tested ? (isAttract ? '-translate-x-[64px]' : 'translate-x-[60px]') : ''}`}>
                    <ChargeCircle type={chargeR} size="lg" className="w-20 h-20 text-4xl shadow-xl z-20 relative" />
                    {/* Force Arrow Right */}
                    {tested && (
                        <div className={`absolute top-1/2 -translate-y-1/2 text-5xl font-bold animate-pulse z-10 ${isAttract ? 'left-[-50px] text-green-500' : 'right-[-50px] text-red-500'}`}>
                            {isAttract ? '‚Üê' : '‚Üí'}
                        </div>
                    )}
                </div>

              </div>

              <div className="flex justify-between w-full max-w-md gap-8">
                <div className="flex gap-2">
                  <Button onClick={() => setChargeL('pos')} disabled={chargeL === 'pos'} className={chargeL === 'pos' ? 'ring-2 ring-red-500' : 'opacity-50'}>+</Button>
                  <Button onClick={() => setChargeL('neg')} disabled={chargeL === 'neg'} className={chargeL === 'neg' ? 'ring-2 ring-blue-500' : 'opacity-50'}>-</Button>
                </div>
                <Button onClick={handleTest} className="bg-purple-600 w-32">Test!</Button>
                <div className="flex gap-2">
                  <Button onClick={() => setChargeR('pos')} disabled={chargeR === 'pos'} className={chargeR === 'pos' ? 'ring-2 ring-red-500' : 'opacity-50'}>+</Button>
                  <Button onClick={() => setChargeR('neg')} disabled={chargeR === 'neg'} className={chargeR === 'neg' ? 'ring-2 ring-blue-500' : 'opacity-50'}>-</Button>
                </div>
              </div>
          </div>
          
          {allDone && (
            <div className="absolute bottom-6 right-6 animate-bounce z-50">
              <Button onClick={onComplete} className="bg-green-500 text-xl px-8 py-3 shadow-2xl border-2 border-white">Next &rarr;</Button>
            </div>
          )}
        </div>
      )
    };

    // --- STAGE 4: Comb ---
    const CombLab = ({ onComplete, settings }) => {
      const [charge, setCharge] = useState(0);
      const [flyingElectrons, setFlyingElectrons] = useState([]);
      const [combPos, setCombPos] = useState({ x: 30, y: 10 }); 

      const handleMove = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = ((clientX - rect.left) / rect.width) * 100;
        const y = ((clientY - rect.top) / rect.height) * 100;
        setCombPos({ x: Math.min(90, Math.max(10, x)), y: Math.min(80, Math.max(5, y)) });

        if (y > 50 && x > 20 && x < 80) {
          if (charge < 12 && Math.random() > 0.85) {
            if(settings.sound) playSound('rub');
            const id = Date.now();
            setFlyingElectrons(prev => [...prev, { id, x: Math.random() * 50, y: Math.random() * 20 }]);
            setTimeout(() => {
              setCharge(c => c + 1);
              setFlyingElectrons(prev => prev.filter(e => e.id !== id));
            }, 600);
          }
        }
      };

      return (
        <div className="flex flex-col md:flex-row items-center justify-center w-full h-full max-w-7xl mx-auto p-2 gap-8 relative">
          <div className="flex-1 flex flex-col items-center md:items-start text-center md:text-left space-y-4 max-w-sm">
             <h2 className="text-2xl font-bold text-purple-600">Mission 4: Charging the Comb</h2>
             <Sparkle message="Steal electrons! Rub the plastic comb on the hair. The friction knocks electrons off the hair and onto the comb." speak={settings.speak} />
             <div className="mt-4"><p className="text-lg">Electrons Stolen: <span className="font-bold text-xl">{charge} / 12</span></p></div>
          </div>

          <div className="flex-1 w-full">
              <div className="relative w-full flex-1 min-h-[300px] bg-pink-50 rounded-xl border-2 border-pink-200 overflow-hidden select-none touch-none cursor-none" onMouseMove={handleMove} onTouchMove={handleMove}>
                {charge < 3 && <GuideArrow text="Rub here!" className="bottom-20 left-1/2 -translate-x-1/2" direction="down" />}
                
                {/* Hair */}
                <div className="absolute bottom-[-15px] left-1/4 w-1/2 h-64 pointer-events-none">
                  {Array.from({length: 30}).map((_,i) => <div key={i} className="absolute bottom-0 w-1 bg-yellow-800 origin-bottom" style={{height: `${120 + Math.random()*80}%`, left: `${i*3.5}%`, transform: `rotate(${(i-15)*2.5}deg)`}}></div>)}
                  <div className="absolute bottom-0 w-full h-20 bg-yellow-900 rounded-t-full flex justify-center items-end pb-2"><span className="text-white opacity-50">HAIR</span></div>
                </div>

                {/* Comb */}
                <div className="absolute w-64 h-24 bg-purple-600 rounded-lg transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-center z-20 shadow-xl pointer-events-none" style={{ left: `${combPos.x}%`, top: `${combPos.y}%` }}>
                  <div className="w-full h-4 bg-purple-700 mt-auto flex justify-around">{Array.from({length:15}).map((_,i) => <div key={i} className="w-1 h-8 bg-purple-600"></div>)}</div>
                  <div className="absolute top-2 text-white font-bold opacity-80">COMB</div>
                  <div className="absolute top-0 right-0 flex flex-wrap w-full h-full p-2 gap-1 justify-center">
                    {Array.from({length: charge}).map((_, i) => <ChargeCircle key={i} type="neg" size="sm" animate={true} />)}
                  </div>
                </div>

                {flyingElectrons.map(e => (
                  <div key={e.id} className="absolute bottom-20 left-1/2 flying-electron" style={{ '--tx': '0px', '--ty': '-150px' }}><ChargeCircle type="neg" /></div>
                ))}
              </div>
          </div>
          
          {charge >= 12 && (
            <div className="absolute bottom-6 right-6 animate-bounce z-50">
              <Button onClick={onComplete} className="bg-green-500 text-xl px-8 py-3 shadow-2xl border-2 border-white">Next Lab &rarr;</Button>
            </div>
          )}
        </div>
      );
    };

    // --- STAGE 5: Balloon Lab ---
    const BalloonLab = ({ onComplete, settings }) => {
      const [subStage, setSubStage] = useState('charge'); 
      const [charge, setCharge] = useState(0);
      const [flying, setFlying] = useState([]);
      const [isComplete, setIsComplete] = useState(false);
      const [papers, setPapers] = useState(Array.from({length: 12}).map((_,i) => ({id:i, initialX: 20 + i*6, clumpOffset: (Math.random() * 10) - 5, lifted: false})));
      const [balloonPos, setBalloonPos] = useState({ x: 80, y: 30 }); 
      
      const canXRef = useRef(20);
      const [canX, setCanX] = useState(20); 
      
      const isStuckRef = useRef(false);

      const targetPos = useRef({ x: 80, y: 30 });
      const requestRef = useRef();

      const animate = useCallback(() => {
        setBalloonPos(prevBalloon => {
            const dx = targetPos.current.x - prevBalloon.x;
            const dy = targetPos.current.y - prevBalloon.y;
            
            let newX = prevBalloon.x;
            let newY = prevBalloon.y;

            if (Math.abs(dx) > 0.1 || Math.abs(dy) > 0.1) {
                newX = prevBalloon.x + dx * 0.15;
                newY = prevBalloon.y + dy * 0.15;
            }

            // --- Physics Logic inside Animation Loop ---
            
            // Wall Logic with Stickiness & Detachment
            if (subStage === 'wall' && charge > 5) {
                const wallX = 15; // Stick point
                const mouseX = targetPos.current.x;
                
                if (isStuckRef.current) {
                    // It is stuck. Check if pulled away enough to detach.
                    if (mouseX > 35) { // Threshold
                        isStuckRef.current = false;
                        if(settings.sound) playSound('pop'); 
                    } else {
                        // Sticky logic: keep balloon at wall, but allow slight vertical movement
                        newX = wallX;
                    }
                } else {
                    // Not stuck. Check if close enough to stick.
                    if (mouseX < 22 && Math.abs(newX - wallX) < 10) {
                         isStuckRef.current = true;
                         newX = wallX;
                         if(settings.sound) playSound('thump');
                         // We set complete only once, but physics continue
                         setIsComplete(true);
                    }
                }
            }

            // Soda Can Logic
            if (subStage === 'can') {
                const dist = newX - canXRef.current;
                if (charge > 5 && Math.abs(dist) < 35 && Math.abs(dist) > 5 && newY > 50) {
                    const moveAmount = dist > 0 ? 0.2 : -0.2; 
                    canXRef.current = Math.max(5, Math.min(95, canXRef.current + moveAmount));
                }
            }

            return { x: newX, y: newY };
        });
        
        if(subStage === 'can') {
             setCanX(canXRef.current);
        }

        requestRef.current = requestAnimationFrame(animate);
      }, [subStage, charge, settings.sound]);

      useEffect(() => { requestRef.current = requestAnimationFrame(animate); return () => cancelAnimationFrame(requestRef.current); }, [animate]);

      // Paper logic - "Chain/Cluster" effect
      useEffect(() => {
        if (subStage === 'paper') {
          setPapers(prev => prev.map((p, i) => {
            const dist = Math.abs(p.initialX - balloonPos.x);
            // Height logic for chains
            const chainHeight = (i % 3) * 5; // Creates simple tiered effect

            if (charge > 5 && dist < 25 && balloonPos.y > 40) { 
                if(!p.lifted && settings.sound && Math.random() > 0.95) playSound('swish');
                return {...p, lifted: true, chainHeight}; 
            }
            // Drop if far away
            if ((dist > 30 || balloonPos.y < 30) && p.lifted) return {...p, lifted: false};
            return p;
          }));
        }
      }, [balloonPos, subStage, charge, settings.sound]);

      const handleInteraction = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = ((clientX - rect.left) / rect.width) * 100;
        const y = ((clientY - rect.top) / rect.height) * 100;
        targetPos.current = { x, y };

        if (subStage === 'charge' && x > 60 && y > 60) {
            if (charge < 15 && Math.random() > 0.8) {
              if(settings.sound) playSound('rub');
              const id = Date.now();
              setFlying(prev => [...prev, {id}]);
              setTimeout(() => { setCharge(c => c + 1); setFlying(prev => prev.filter(x => x.id !== id)); }, 500);
            }
        } 
      };

      const getMsg = () => {
        if(subStage==='charge') return "Rub the balloon on the sweater to steal negative electrons!";
        if(subStage==='paper') return "Hover over the paper. The negative balloon pushes paper electrons away, leaving positive tops. Opposites attract!";
        if(subStage==='can') return "The can is neutral, but the balloon polarizes it. Pull the can across the table!";
        return "Stick the balloon to the wall! It pushes wall electrons deeper, sticking to the positive surface.";
      };

      const getContextLabel = () => {
          if(subStage==='charge') return "Friction transfers Electrons!";
          if(subStage==='paper' || subStage==='can') return "Opposites Attract! (+ ‚ù§ -)";
          if(subStage==='wall') return "Like Charges Repel (Electrons move away)";
          return "";
      };

      return (
        <div className="flex flex-col md:flex-row items-center justify-center w-full h-full max-w-7xl mx-auto p-2 gap-4 relative">
          <div className="flex-1 flex flex-col items-center md:items-start text-center md:text-left space-y-4 max-w-sm">
            <Sparkle message={getMsg()} speak={settings.speak} />
            
            {/* Zoom In Panel */}
            {['charge', 'paper', 'can', 'wall'].includes(subStage) && (
              <div className="w-full bg-blue-50 rounded-xl border-4 border-blue-200 p-2 shadow-inner h-52 mt-2 hidden md:block relative">
                <h4 className="font-bold text-blue-800 text-center mb-1 text-sm border-b border-blue-200">Zoom In üîç</h4>
                <div className="bg-white rounded-lg border border-gray-300 h-32 flex flex-col overflow-hidden">
                  <div className="h-1/2 bg-purple-500 flex flex-wrap gap-1 items-center justify-center p-1 relative">
                    <span className="absolute top-0 left-1 text-white/50 text-[8px]">Balloon</span>
                    {charge > 0 ? Array.from({length: Math.min(charge, 10)}).map((_,i)=><ChargeCircle key={i} type="neg" size="sm" style={{transform: 'scale(0.8)'}} />) : <span className="text-white/60 text-[10px]">Neutral</span>}
                  </div>
                  <div className="h-1/2 bg-gray-100 flex flex-col items-center justify-center p-1 relative">
                     <span className="absolute bottom-0 right-1 text-gray-400 text-[8px]">Target</span>
                     
                     {/* CHARGE */}
                     {subStage === 'charge' && (
                        <div className="flex gap-1">{Array.from({length: 5}).map((_,i)=><div key={i} className="flex flex-col items-center"><ChargeCircle type="pos" size="sm" style={{transform: 'scale(0.8)'}}/>{i<(15-charge) && <ChargeCircle type="neg" size="sm" className="-mt-3" style={{transform: 'scale(0.8)'}}/>}</div>)}</div>
                     )}

                     {/* PAPER / CAN */}
                     {['paper','can'].includes(subStage) && (
                        <div className="flex flex-col gap-1 items-center">
                           <div className="flex gap-1">
                               {Array.from({length: 5}).map((_,i)=>(
                                   <div key={i} className="relative w-4 h-6 flex flex-col items-center justify-center">
                                        {/* Protons Stay */}
                                        <ChargeCircle type="pos" size="sm" style={{transform: 'scale(0.8)'}}/>
                                        
                                        {/* Electrons Run Away when balloon is close */}
                                        <ChargeCircle 
                                            type="neg" 
                                            size="sm" 
                                            style={{transform: 'scale(0.8)'}}
                                            className={`absolute transition-all duration-500 ${
                                                charge > 5 && (subStage==='paper'?balloonPos.y>50:Math.abs(balloonPos.x-canX)<40) 
                                                ? 'translate-y-4 opacity-50' 
                                                : ''
                                            }`}
                                        />
                                   </div>
                               ))}
                           </div>
                           {charge > 5 && (subStage==='paper'?balloonPos.y>50:Math.abs(balloonPos.x-canX)<40) && <div className="flex gap-1 animate-bounce text-[8px] font-bold text-blue-500">Run Away! ‚Üì</div>}
                        </div>
                     )}

                     {/* WALL - Zoom In: Protons Fixed, Electrons Move Left */}
                     {subStage === 'wall' && (
                        <div className="flex gap-1 items-center relative w-full justify-center">
                            {Array.from({length: 5}).map((_, i) => (
                                <div key={i} className="relative w-4 h-6 flex items-center justify-center">
                                    <ChargeCircle type="pos" size="sm" style={{transform: 'scale(0.8)'}} />
                                    {/* Wall electrons move LEFT (away from balloon on right) */}
                                    <ChargeCircle 
                                        type="neg" 
                                        size="sm" 
                                        style={{transform: 'scale(0.8)'}}
                                        className={`absolute transition-transform duration-500 ${charge > 5 && balloonPos.x < 35 ? '-translate-x-3 opacity-60' : ''}`}
                                    />
                                </div>
                            ))}
                        </div>
                     )}
                  </div>
                </div>
                <div className="text-center font-bold text-[10px] bg-yellow-100 p-1 mt-1 rounded border border-yellow-300 text-yellow-800">
                    {getContextLabel()}
                </div>
              </div>
            )}

            <div className="flex flex-wrap gap-2 justify-center md:justify-start w-full">
                {['charge','paper','can','wall'].map(s => (
                    <button key={s} onClick={() => setSubStage(s)} disabled={s !== 'charge' && charge < 5} className={`px-3 py-1 rounded-lg font-bold capitalize text-sm whitespace-nowrap ${subStage===s?'bg-purple-600 text-white':'bg-white text-purple-600 border border-purple-200'} ${s!=='charge'&&charge<5?'opacity-50':''}`}>{s}</button>
                ))}
            </div>
          </div>

          <div className="flex-1 w-full flex flex-col">
              <div className="relative w-full flex-1 min-h-[300px] bg-slate-200 rounded-xl border-4 border-slate-300 overflow-hidden select-none touch-none shadow-inner cursor-none" onMouseMove={handleInteraction} onTouchMove={handleInteraction}>
                 {subStage === 'charge' && (
                     <div className="absolute bottom-0 right-0 w-72 h-48 bg-orange-700 rounded-tl-[60px] border-t-4 border-l-4 border-orange-800 shadow-2xl overflow-hidden">
                         <div className="absolute bottom-2 right-4 bg-white/30 text-white font-bold px-2 py-1 rounded rotate-[-5deg] pointer-events-none text-sm border border-white/50 shadow-sm backdrop-blur-sm">Wool Sweater</div>
                         <div className="absolute inset-0 flex flex-wrap content-center justify-center gap-4 p-6">
                            {Array.from({length: 15}).map((_, i) => (
                                <div key={i} className="relative w-8 h-8 flex items-center justify-center bg-orange-800/50 rounded-full">
                                    <ChargeCircle type="pos" size="md" className="absolute opacity-50" />
                                    {i < (15 - charge) && <ChargeCircle type="neg" size="md" className="absolute z-10 animate-pulse" />}
                                </div>
                            ))}
                         </div>
                     </div>
                 )}
                 {subStage === 'paper' && (
                     <div className="absolute bottom-10 left-0 w-full flex justify-center h-20 items-end">
                         {papers.map((p, i) => (
                             <div key={p.id} className="absolute bg-white w-6 h-8 shadow-sm border border-gray-300 flex flex-col items-center justify-center" 
                                  style={{ 
                                    left: `${p.initialX}%`, 
                                    bottom: p.lifted ? '0px' : '0px', 
                                    transform: `
                                        translateX(${p.lifted ? (balloonPos.x - p.initialX) * 0.1 : 0}px)
                                        translateY(${p.lifted ? -50 - p.chainHeight : 0}px) 
                                        rotate(${p.lifted ? (i % 2 === 0 ? 10 : -10) : p.clumpOffset * 2}deg)
                                    `,
                                    zIndex: p.lifted ? 50 : 1,
                                    transition: 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)' 
                                  }}>
                                <ChargeCircle type="pos" size="sm" className="mb-[-4px]" />
                                <ChargeCircle type="neg" size="sm" className={`transition-transform duration-300 ${p.lifted ? 'translate-y-4 opacity-50' : ''}`} />
                             </div>
                         ))}
                         <div className="absolute bottom-[-10px] w-full h-4 bg-gray-400"></div>
                     </div>
                 )}
                 {subStage === 'can' && (
                     <div className="absolute bottom-8 w-20 h-28 bg-gray-300 border-t-4 border-b-4 border-gray-400 rounded-lg shadow-xl flex flex-col items-center justify-center overflow-hidden transition-all duration-300 ease-out" 
                          style={{ left: `${canX}%`, transform: 'translateX(-50%)', background: 'linear-gradient(90deg, #d1d5db 0%, #f3f4f6 50%, #9ca3af 100%)' }}>
                         <div className="w-full h-full absolute inset-0 flex flex-col justify-center gap-2 items-center z-10">
                            {/* Neutral Can visualization - no visible charges on can itself to keep it clean */}
                            <div className="w-full h-1 bg-gray-400 opacity-20 rotate-45 transform scale-150"></div>
                         </div>
                     </div>
                 )}
                 {subStage === 'wall' && (
                    <div className="absolute top-0 left-0 w-32 h-full bg-amber-100 border-r-4 border-amber-200 flex flex-col items-center justify-center overflow-hidden">
                        <div className="absolute inset-0 flex flex-col justify-around p-2">
                            {Array.from({length: 6}).map((_, r) => (
                                <div key={r} className="flex justify-around">
                                    {Array.from({length: 2}).map((_, c) => (
                                        <div key={c} className="relative w-8 h-8 flex items-center justify-center">
                                            <ChargeCircle type="pos" size="md" className="absolute" />
                                            {/* Wall Electrons Push Deep (Left) */}
                                            <ChargeCircle 
                                                type="neg" 
                                                size="md" 
                                                className={`absolute transition-transform duration-500 ease-out ${charge > 5 && balloonPos.x < 35 ? '-translate-x-6 opacity-60 scale-75' : ''}`} 
                                            />
                                        </div>
                                    ))}
                                </div>
                            ))}
                        </div>
                        <div className="text-amber-800/20 font-bold text-4xl rotate-90 z-10 pointer-events-none">WALL</div>
                    </div>
                 )}

                 <div className="absolute w-32 h-40 pointer-events-none z-50" style={{ left: `${balloonPos.x}%`, top: `${balloonPos.y}%`, transform: 'translate(-50%, -50%)' }}>
                     <div className="w-full h-full bg-purple-500 rounded-[50%_50%_50%_50%_/_40%_40%_60%_60%] shadow-xl flex items-center justify-center relative">
                         <div className="absolute bottom-[-8px] w-4 h-4 bg-purple-600 rounded-full"></div>
                         <div className="flex flex-wrap justify-center gap-1 px-4 content-center h-full pb-4">
                            {Array.from({length: charge}).map((_, i) => <ChargeCircle key={i} type="neg" size="sm" />)}
                         </div>
                     </div>
                 </div>
                 {flying.map(f => <div key={f.id} className="absolute bottom-10 right-10 flying-electron" style={{ '--tx': '-100px', '--ty': '-200px' }}><ChargeCircle type="neg" /></div>)}
              </div>
          </div>
          
          {subStage === 'wall' && isComplete && (
            <div className="absolute bottom-6 right-6 animate-bounce z-50">
              <Button onClick={onComplete} className="bg-green-500 text-xl px-8 py-3 shadow-2xl border-2 border-white">Mission Complete &rarr;</Button>
            </div>
          )}
        </div>
      );
    };

    // --- EXPERIMENT ILLUSTRATION COMPONENT ---
    // Renders visual simulation for everyday life examples
    const ExperimentIllustration = ({ id }) => {
        // Animation CSS classes for specific scenarios
        const cloudAnim = "animate-[bounce_3s_infinite]";
        
        switch(id) {
            case 1: // Lightning
                return (
                    <div className="w-full h-64 bg-gray-700 relative overflow-hidden rounded-xl border-4 border-yellow-200">
                        {/* Cloud */}
                        <div className={`absolute top-4 left-1/2 -translate-x-1/2 w-48 h-24 bg-gray-500 rounded-full flex items-center justify-center gap-2 ${cloudAnim}`}>
                             <div className="absolute bottom-2 flex gap-1">
                                <ChargeCircle type="neg" size="sm" /><ChargeCircle type="neg" size="sm" /><ChargeCircle type="neg" size="sm" />
                             </div>
                        </div>
                        {/* Bolt */}
                        <div className="absolute top-28 left-1/2 -translate-x-1/2 text-6xl text-yellow-400 animate-pulse">‚ö°</div>
                        {/* Ground */}
                        <div className="absolute bottom-0 w-full h-16 bg-green-800 flex items-center justify-center gap-4">
                            <ChargeCircle type="pos" size="sm" /><ChargeCircle type="pos" size="sm" /><ChargeCircle type="pos" size="sm" />
                        </div>
                    </div>
                );
            case 2: // Doorknob
                return (
                    <div className="w-full h-64 bg-amber-50 relative overflow-hidden rounded-xl border-4 border-orange-200 flex items-center justify-center gap-8">
                         {/* Hand */}
                         <div className="text-8xl relative group">
                            üëà
                            <div className="absolute right-0 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity text-yellow-500 text-4xl font-bold animate-ping">üí•</div>
                         </div>
                         {/* Knob */}
                         <div className="w-16 h-16 bg-yellow-600 rounded-full border-4 border-yellow-700 shadow-xl"></div>
                    </div>
                );
            case 3: // Dryer
                return (
                    <div className="w-full h-64 bg-blue-50 relative overflow-hidden rounded-xl border-4 border-blue-200 flex items-center justify-center">
                        <div className="w-48 h-48 border-8 border-gray-300 rounded-full flex items-center justify-center animate-[spin_5s_linear_infinite] bg-white">
                            <div className="text-4xl">üëï</div>
                            <div className="text-4xl absolute translate-x-8 translate-y-4">üß¶</div>
                            <div className="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100">
                                <ChargeCircle type="neg" className="absolute top-10" />
                                <ChargeCircle type="pos" className="absolute bottom-10" />
                            </div>
                        </div>
                    </div>
                );
            case 4: // Copier
                return (
                    <div className="w-full h-64 bg-gray-100 relative overflow-hidden rounded-xl border-4 border-gray-300 flex flex-col items-center justify-center">
                        <div className="w-64 h-12 bg-black rounded-full mb-2 animate-pulse relative">
                             <div className="absolute top-0 left-0 w-full h-full flex justify-center items-center gap-2">
                                <ChargeCircle type="pos" size="sm" /> <ChargeCircle type="pos" size="sm" />
                             </div>
                        </div>
                        <div className="w-64 h-32 bg-white border-2 border-gray-400 flex items-center justify-center relative">
                            <span className="text-4xl">üìÑ</span>
                            <div className="absolute top-0 w-full h-1 bg-green-500 animate-[ping_2s_infinite]"></div>
                        </div>
                    </div>
                );
            case 5: // Slide
                return (
                    <div className="w-full h-64 bg-sky-100 relative overflow-hidden rounded-xl border-4 border-sky-300 flex items-end justify-center">
                         <div className="w-full h-8 bg-green-500 absolute bottom-0"></div>
                         <div className="w-4 h-48 bg-gray-400 absolute left-1/4 bottom-0"></div>
                         <div className="w-64 h-4 bg-red-400 absolute bottom-32 rotate-[-20deg] rounded-full"></div>
                         <div className="text-6xl absolute bottom-10 left-1/2 -translate-x-1/2 mb-4 relative">
                             üßë
                             {/* Hair standing up */}
                             <div className="absolute -top-4 left-0 w-full flex justify-center gap-1">
                                 <div className="w-0.5 h-6 bg-black rotate-[-30deg]"></div>
                                 <div className="w-0.5 h-8 bg-black"></div>
                                 <div className="w-0.5 h-6 bg-black rotate-[30deg]"></div>
                             </div>
                         </div>
                    </div>
                );
            case 6: // Water
                 return (
                    <div className="w-full h-64 bg-white relative overflow-hidden rounded-xl border-4 border-cyan-200">
                        {/* Faucet */}
                        <div className="absolute top-0 left-8 text-6xl">üö∞</div>
                        {/* Water Stream Bending */}
                        <svg className="absolute top-14 left-14 w-32 h-48" style={{fill:'none', stroke:'#3b82f6', strokeWidth:4}}>
                            <path d="M 10 0 Q 10 100 60 150" />
                        </svg>
                        {/* Comb */}
                        <div className="absolute top-1/2 right-12 text-6xl rotate-[-45deg]">
                            ü™Æ
                            <div className="absolute -top-2 -left-2 flex gap-1">
                                <ChargeCircle type="neg" size="sm" />
                                <ChargeCircle type="neg" size="sm" />
                            </div>
                        </div>
                    </div>
                 );
            default: return null;
        }
    };


    // --- STAGE 6: Everyday Life ---
    const RealLifeLab = ({ onComplete, settings }) => {
        const [active, setActive] = useState(null);
        // Detail view content
        const details = {
            1: { title: "Lightning", icon: "üå©Ô∏è", color: "bg-yellow-100", 
                 scenario: "A storm is brewing. Clouds are moving fast and rubbing against each other.",
                 science: "Ice crystals and water droplets inside clouds rub together (Friction). Negative charges sink to the bottom of the cloud, while the ground becomes positive.",
                 fix: "Safety: Stay indoors! Lightning rods on buildings provide a safe path for the charge to reach the ground." },
            2: { title: "Doorknob Shock", icon: "üö™", color: "bg-gray-100", 
                 scenario: "You walk across a carpet in your socks and reach for a metal doorknob.",
                 science: "Friction between your socks and the carpet strips electrons. You build up a static charge. Metal is a conductor, so the electrons jump (spark) to neutralize.",
                 fix: "Fix: Touch a wooden door frame or wall first to discharge slowly. Use a humidifier to reduce dry air." },
            3: { title: "Clothes Dryer", icon: "üëñ", color: "bg-blue-100", 
                 scenario: "You pull clothes out of the dryer and they are stuck together.",
                 science: "Tumbling clothes rub against each other constantly. Electrons transfer between different fabrics, causing them to attract (Static Cling).",
                 fix: "Fix: Dryer sheets coat the fabric with a substance that reduces friction and prevents charge buildup." },
            4: { title: "Photocopier", icon: "üñ®Ô∏è", color: "bg-green-100", 
                 scenario: "You need to make a copy of a drawing.",
                 science: "This is a USEFUL type of static! A drum gets charged. Light draws your image by erasing charge. Static holds toner (powder) to the drum, then transfers it to paper.",
                 fix: "Fun Fact: Laser printers use the same static electricity principle to print your homework!" },
            5: { title: "Plastic Slide", icon: "üõù", color: "bg-pink-100", 
                 scenario: "You go down a plastic slide and your hair stands straight up!",
                 science: "Sliding creates friction, transferring electrons from the slide to you. Your hairs all get the same negative charge. Since like charges repel, each strand pushes away from its neighbor!",
                 fix: "Fix: Touch the metal pole of the playground equipment to discharge safely." },
            6: { title: "Bending Water", icon: "üö∞", color: "bg-cyan-100", 
                 scenario: "You comb your hair and bring the comb near a thin stream of water.",
                 science: "The comb gets charged from your hair. Water molecules are neutral but have positive and negative ends. The charged comb attracts the opposite ends of the water molecules, pulling the stream sideways!",
                 fix: "Fun Fact: This is a great party trick to show your friends!" }
        };

        const list = [
            {id:1,i:'üå©Ô∏è',t:'Lightning',d:'Clouds rub together -> huge charge!'}, 
            {id:2,i:'üö™',t:'Shock',d:'Rug rubbing steals electrons from you.'}, 
            {id:3,i:'üëñ',t:'Dryer',d:'Clothes rubbing makes them stick.'}, 
            {id:4,i:'üñ®Ô∏è',t:'Copier',d:'Static holds toner to paper.'},
            {id:5,i:'üõù',t:'Slide',d:'Hair stands up after sliding!'},
            {id:6,i:'üö∞',t:'Water',d:'Bending water with a comb!'}
        ];
        
        const [visited, setVisited] = useState([]); 
        const [detailView, setDetailView] = useState(null);

        const handleVisit = (id) => {
            if(!visited.includes(id)) setVisited([...visited, id]);
            setDetailView(details[id]);
            if(settings.sound) playSound('pop');
        };

        // Split Screen Detail View
        if (detailView) {
            return (
                <div className="flex flex-col items-center justify-center w-full h-full max-w-7xl mx-auto p-4 animate-fadeIn">
                    <div className={`w-full max-w-5xl bg-white p-6 rounded-xl shadow-2xl border-4 ${detailView.color.replace('bg-', 'border-').replace('100','300')} relative flex flex-col md:flex-row gap-6`}>
                        <button onClick={() => setDetailView(null)} className="absolute top-2 right-2 text-gray-400 hover:text-gray-800 text-lg font-bold z-50">‚úï Close</button>
                        
                        {/* Left: Text Content */}
                        <div className="flex-1 flex flex-col gap-4">
                            <div className="flex items-center gap-3 border-b pb-2">
                                <div className="text-5xl">{detailView.icon}</div>
                                <h2 className="text-3xl font-bold text-gray-800">{detailView.title}</h2>
                            </div>
                            
                            <div className="space-y-3 text-gray-700 overflow-y-auto max-h-[40vh] md:max-h-none pr-2">
                                <div>
                                    <h3 className="font-bold text-purple-600">Scenario:</h3>
                                    <p className="text-sm md:text-base">{detailView.scenario}</p>
                                </div>
                                <div className="bg-purple-50 p-3 rounded-lg border border-purple-100">
                                    <h3 className="font-bold text-purple-600">The Science:</h3>
                                    <p className="text-sm md:text-base">{detailView.science}</p>
                                </div>
                                <div className="flex items-start gap-2">
                                    <span className="text-xl">üí°</span>
                                    <p className="font-medium italic text-gray-600 text-sm md:text-base">{detailView.fix}</p>
                                </div>
                            </div>
                            <div className="mt-auto pt-4">
                                <Button onClick={() => setDetailView(null)} className="bg-gray-500 hover:bg-gray-600 w-full md:w-auto">Back to Menu</Button>
                            </div>
                        </div>

                        {/* Right: Illustration */}
                        <div className="flex-1 bg-gray-50 rounded-lg border-2 border-gray-200 flex items-center justify-center p-4">
                             {/* Find the ID by title matching is hacky, better pass ID from state */}
                             <ExperimentIllustration id={Object.keys(details).find(key => details[key].title === detailView.title) ? parseInt(Object.keys(details).find(key => details[key].title === detailView.title)) : 1} />
                        </div>
                    </div>
                </div>
            );
        }

        return (
            <div className="flex flex-col md:flex-row items-center justify-center w-full h-full max-w-7xl mx-auto p-4 gap-8 relative">
                <div className="flex-1 flex flex-col items-center md:items-start text-center md:text-left space-y-4 max-w-sm">
                    <h2 className="text-2xl font-bold text-purple-600">Mission 6: Everyday Life</h2>
                    <Sparkle message="Explore all 6 examples to unlock the Final Quiz!" speak={settings.speak} />
                </div>
                
                <div className="flex-1 grid grid-cols-2 md:grid-cols-3 gap-4 w-full">
                    {list.map(ex => (
                        <div key={ex.id} onClick={() => handleVisit(ex.id)} className={`p-3 md:p-4 rounded-xl border-4 cursor-pointer hover:scale-105 bg-white relative overflow-hidden flex flex-col items-center justify-center text-center ${visited.includes(ex.id) ? 'border-green-400' : ''}`}>
                            {visited.includes(ex.id) && <div className="absolute top-1 right-1 text-green-500 font-bold text-sm">‚úÖ</div>}
                            <div className="text-3xl md:text-4xl mb-1">{ex.i}</div>
                            <h3 className="text-xs md:text-sm font-bold leading-tight">{ex.t}</h3>
                        </div>
                    ))}
                </div>
                
                {visited.length === 6 && (
                    <div className="absolute bottom-6 right-6 animate-bounce z-50">
                        <Button onClick={onComplete} className="bg-purple-600 px-8 py-3 shadow-2xl border-2 border-white">Take Quiz &rarr;</Button>
                    </div>
                )}
            </div>
        )
    };

    // --- STAGE 7: Quiz ---
    const QuizLevel = ({ onComplete, settings }) => {
        const [q, setQ] = useState(0);
        const [feed, setFeed] = useState(false);
        const [ok, setOk] = useState(false);
        const [score, setScore] = useState(0);
        
        // Updated Quiz Questions: 5 full sentences with full phrase options
        const qs = [
            {
                q: "What is the electric charge of a single electron?",
                o: ["It has a Positive charge", "It has a Negative charge", "It has no charge (Neutral)"],
                a: 1, 
                r: "Electrons are the negatively charged particles that orbit the nucleus."
            }, 
            {
                q: "What occurs when two objects with the same charge are brought near each other?",
                o: ["They will attract each other", "They will repel or push away", "Nothing will happen"],
                a: 1, 
                r: "Like charges always repel each other, while opposite charges attract."
            }, 
            {
                q: "Which part of the atom contains the Protons and Neutrons?",
                o: ["They orbit in the outer shells", "They are inside the Nucleus", "They are floating in the air"],
                a: 1, 
                r: "The Nucleus is the dense center of the atom housing Protons and Neutrons."
            }, 
            {
                q: "How does the balloon become charged when rubbed on the sweater?",
                o: ["It gains electrons from the sweater", "It creates new protons", "The sweater melts onto it"],
                a: 0, 
                r: "Friction transfers electrons from the wool sweater to the balloon, giving it a negative charge."
            },
            {
                q: "Why does the negatively charged balloon stick to the neutral wall?",
                o: ["The wall becomes a magnet", "The balloon pushes wall electrons away, creating attraction", "The glue from the balloon holds it"],
                a: 1, 
                r: "The balloon repels electrons in the wall, creating a positive surface that attracts the negative balloon (polarization)."
            }
        ];

        const ans = (i) => {
            const isCor = i === qs[q].a;
            setOk(isCor); setFeed(true);
            if(isCor) { setScore(s=>s+1); if(settings.sound) playSound('success'); } else { if(settings.sound) playSound('fail'); }
        };
        const next = () => { setFeed(false); if(q<qs.length-1) setQ(q+1); else onComplete(score); };

        return (
            <div className="flex flex-col md:flex-row items-center justify-center w-full h-full max-w-6xl mx-auto p-4 gap-8 relative">
                <div className="flex-1 flex flex-col items-center md:items-start text-center md:text-left space-y-4 max-w-sm">
                    <h2 className="text-2xl font-bold text-purple-600">Final Quiz</h2>
                    <Sparkle 
                        message={feed ? (ok ? "Correct! " : "Oops! ") + qs[q].r : qs[q].q} 
                        emotion={feed ? (ok ? 'excited' : 'shocked') : 'happy'}
                        speak={settings.speak} 
                    />
                </div>

                <div className="flex-1 bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl border-2 border-purple-100 text-center">
                    <div className="text-gray-500 font-bold mb-2">Question {q+1} of {qs.length}</div>
                    <h3 className="text-xl md:text-2xl font-bold mb-6">{qs[q].q}</h3>
                    {!feed ? (
                        <div className="space-y-3">{qs[q].o.map((o,i)=><button key={i} onClick={()=>ans(i)} className="w-full p-4 rounded-lg bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 font-bold text-base md:text-lg text-left">{o}</button>)}</div>
                    ) : (
                        <div className="animate-fadeIn">
                            <div className="text-6xl mb-4">{ok?'‚úÖ':'‚ùå'}</div>
                            <h3 className="text-2xl font-bold mb-2">{ok ? 'Correct!' : 'Oops, not quite!'}</h3>
                            <p className="text-gray-600 mb-6 text-base md:text-lg px-4">{qs[q].r}</p>
                        </div>
                    )}
                </div>
                
                {feed && (
                    <div className="absolute bottom-6 right-6 animate-bounce z-50">
                        <Button onClick={next} className="bg-purple-600 px-8 py-3 shadow-2xl border-2 border-white">Next &rarr;</Button>
                    </div>
                )}
            </div>
        )
    };

    // --- STAGE 8: Lab Report (Wrap-Up Summary) ---
    const SummaryLevel = ({ onComplete, settings }) => {
        return (
            <div className="flex flex-col md:flex-row items-center justify-center w-full h-full max-w-6xl mx-auto p-4 gap-8 relative">
                <div className="flex-1 flex flex-col items-center md:items-start text-center md:text-left space-y-4 max-w-sm">
                    <h2 className="text-3xl font-bold text-purple-800">Lab Report Summary</h2>
                    <Sparkle message="Excellent work Scientist! Here is what we discovered today." speak={settings.speak} />
                </div>
                
                <div className="flex-1 bg-white p-8 rounded-xl shadow-xl border-l-8 border-purple-500 w-full space-y-6">
                    <div className="flex items-center gap-4">
                        <div className="text-4xl">‚öõÔ∏è</div>
                        <div>
                            <h3 className="font-bold text-xl">The Atom</h3>
                            <p className="text-gray-600">Protons (+) and Neutrons (0) are stuck in the center. Electrons (-) fly around the outside.</p>
                        </div>
                    </div>
                    <div className="w-full h-px bg-gray-200"></div>
                    <div className="flex items-center gap-4">
                        <div className="text-4xl">üß≤</div>
                        <div>
                            <h3 className="font-bold text-xl">The Rules of Charge</h3>
                            <p className="text-gray-600">Opposites Attract (+ likes -). Likes Repel (+ hates +).</p>
                        </div>
                    </div>
                    <div className="w-full h-px bg-gray-200"></div>
                    <div className="flex items-center gap-4">
                        <div className="text-4xl">üéà</div>
                        <div>
                            <h3 className="font-bold text-xl">Static Electricity</h3>
                            <p className="text-gray-600">Rubbing things together (Friction) steals electrons. The object that gains electrons becomes negative!</p>
                        </div>
                    </div>
                </div>
                
                <div className="absolute bottom-6 right-6 animate-bounce z-50">
                    <Button onClick={onComplete} className="bg-green-600 text-xl px-10 py-4 hover:bg-green-700 shadow-xl border-2 border-white">
                        Get Certificate üéì
                    </Button>
                </div>
            </div>
        )
    }

    // --- STAGE 9: Certificate ---
    const WrapUp = ({ settings }) => {
        const [studentName, setStudentName] = useState("");
        const [section, setSection] = useState("");

        useEffect(() => { if(settings.sound) playSound('win'); }, []);
        
        return (
            <div className="flex flex-col md:flex-row items-center justify-center w-full h-full p-4 animate-fadeIn relative overflow-hidden gap-8">
                 {Array.from({length: 50}).map((_,i) => <div key={i} className="confetti" style={{left: `${Math.random()*100}%`, animationDuration: `${2+Math.random()*3}s`, backgroundColor: ['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)]}}></div>)}
                
                <div className="flex-1 flex flex-col items-center text-center max-w-sm z-10">
                    <div className="text-8xl mb-4 animate-bounce">üéì</div>
                    <h1 className="text-4xl md:text-5xl font-bold text-purple-800 mb-4 font-comic">Congratulations!</h1>
                    <h2 className="text-xl md:text-2xl font-bold text-green-600 mb-8">You are a Certified Sparkle Young Scientist!</h2>
                    
                    <div className="w-full bg-white/50 p-4 rounded-lg border border-purple-200 shadow-sm space-y-3">
                        <input 
                            type="text" 
                            placeholder="Enter Your Name" 
                            className="w-full p-2 rounded border border-gray-300"
                            value={studentName}
                            onChange={(e) => setStudentName(e.target.value)}
                        />
                        <input 
                            type="text" 
                            placeholder="Enter Section/Grade" 
                            className="w-full p-2 rounded border border-gray-300"
                            value={section}
                            onChange={(e) => setSection(e.target.value)}
                        />
                    </div>
                    <div className="mt-6"><Button onClick={() => window.location.reload()} className="bg-gray-500 hover:bg-gray-600">Restart Lab</Button></div>
                </div>

                <div className="flex-1 bg-white p-8 md:p-10 rounded-xl shadow-2xl border-8 border-yellow-400 max-w-2xl w-full rotate-1 transform hover:rotate-0 transition-transform relative z-10">
                    <div className="absolute top-4 right-4 text-4xl opacity-20">‚ö°</div>
                    <div className="absolute bottom-4 left-4 text-4xl opacity-20">‚öõÔ∏è</div>
                    
                    <h2 className="text-3xl font-bold text-center text-purple-800 mb-2 font-serif">Certificate of Achievement</h2>
                    <p className="text-center text-gray-500 mb-8">LaSallian Young Scientist Certification</p>
                    
                    <p className="text-center text-lg mb-2">This certifies that</p>
                    <div className="text-center text-3xl font-bold text-blue-700 border-b-2 border-gray-300 pb-2 mb-2 font-comic min-h-[40px]">
                        {studentName || "Future Scientist"}
                    </div>
                    <div className="text-center text-gray-500 text-sm mb-6">{section || "Grade 5 Science"}</div>
                    
                    <p className="text-center text-lg text-gray-700 mb-8">Has successfully mastered the secrets of Atoms, Charges, and Static Electricity.</p>
                    
                    <div className="flex justify-between items-end mt-12 px-8">
                         <div className="text-center">
                             <div className="font-script text-2xl text-purple-600 font-cursive mb-1">Ms. Sparkle</div>
                             <div className="border-t border-gray-400 text-sm w-32 mx-auto pt-1">Lab Director</div>
                         </div>
                         <div className="text-center">
                             <div className="text-sm font-bold text-gray-600 mb-1">{new Date().toLocaleDateString()}</div>
                             <div className="border-t border-gray-400 text-sm w-32 mx-auto pt-1">Date</div>
                         </div>
                    </div>
                </div>
            </div>
        )
    };

    // --- SHARED FOOTER COMPONENT ---
    const Footer = ({ stage }) => {
        const otherSims = [
            { title: "Simple Circuits", icon: "üîã" },
            { title: "Open & Closed", icon: "üîå" },
            { title: "Series & Parallel", icon: "üí°" },
            { title: "Insulators and Conductors", icon: "üóùÔ∏è" }
        ];

        // Notes learned based on completed stages
        const concepts = [
            { s: 2, text: "Atoms: Protons/Neutrons inside, Electrons outside." },
            { s: 3, text: "Electrons are loose and can move!" },
            { s: 4, text: "Opposites Attract (+/-). Likes Repel (+/+)." },
            { s: 5, text: "Friction transfers electrons to charge things." },
            { s: 6, text: "Charged objects attract neutral ones (Polarization)." },
            { s: 7, text: "Static electricity is everywhere in real life!" }
        ];
        const visibleNotes = concepts.filter(c => stage >= c.s);

        return (
            <div className="bg-gray-200 w-full p-2 border-t-4 border-gray-300 shrink-0 h-28 md:h-32 flex flex-col justify-center relative overflow-hidden">
                {stage === 0 ? (
                    <>
                        <h3 className="text-center font-bold text-gray-500 mb-2 text-xs md:text-sm">Coming Soon: More Simulations from Sir Angelo Medez, LPT</h3>
                        <div className="grid grid-cols-4 gap-3 max-w-4xl mx-auto w-full px-4">
                            {otherSims.map((sim, idx) => (
                                <div key={idx} className="bg-gray-300 rounded-lg p-2 flex flex-col items-center justify-center text-gray-500 relative overflow-hidden h-16 md:h-20 shadow-inner border border-gray-400/50 opacity-70">
                                    <div className="absolute top-1 right-1 text-[10px] opacity-50">üîí</div>
                                    <div className="text-xl grayscale mb-1 opacity-50">{sim.icon}</div>
                                    <span className="text-[10px] font-bold text-center leading-tight hidden md:block">{sim.title}</span>
                                </div>
                            ))}
                        </div>
                    </>
                ) : (
                    <>
                        <h3 className="text-center font-bold text-gray-500 text-xs md:text-sm absolute top-1 left-0 w-full">My Science Journal üìì</h3>
                        <div className="flex gap-2 items-center h-full px-4 pt-5 overflow-x-auto w-full no-scrollbar">
                            {visibleNotes.length === 0 && <span className="text-gray-400 italic text-sm w-full text-center">Complete experiments to add notes...</span>}
                            {visibleNotes.map((note, idx) => (
                                <div key={idx} className="bg-yellow-200 text-yellow-900 p-2 text-[10px] md:text-xs shadow-md border-b-2 border-yellow-300 w-32 md:w-40 shrink-0 h-16 md:h-20 flex items-center justify-center text-center font-comic transform hover:scale-105 transition-transform rotate-1" style={{transform: `rotate(${idx % 2 === 0 ? -2 : 2}deg)`}}>
                                    {note.text}
                                </div>
                            ))}
                        </div>
                    </>
                )}
            </div>
        );
    };

    // --- MAIN APP ---
    const App = () => {
        const [stage, setStage] = useState(0);
        const [settings, setSettings] = useState({ sound: true, speak: true, music: true });
        const [showInfo, setShowInfo] = useState(false);
        const [showJournal, setShowJournal] = useState(false);
        const musicRef = useRef(null);
        const noteIndexRef = useRef(0);

        const nextStage = () => setStage(s => s + 1);
        const toggleMusic = () => setSettings(p => ({...p, music: !p.music}));

        useEffect(() => {
            if (settings.music && stage > 0) { 
                if (!musicRef.current) {
                    musicRef.current = setInterval(() => { playMusicNote(noteIndexRef.current); noteIndexRef.current++; }, 800);
                }
            } else {
                if (musicRef.current) { clearInterval(musicRef.current); musicRef.current = null; }
            }
            return () => { if(musicRef.current) clearInterval(musicRef.current); };
        }, [settings.music, stage]);

        const startApp = () => { initAudio(); nextStage(); }

        const labels = ['Intro', 'Atoms', 'Shells', 'Forces', 'Comb', 'Balloon', 'Everyday Life', 'Quiz', 'Summary', 'Done'];

        return (
            <div className="h-screen w-screen flex flex-col overflow-hidden bg-[#f0f9ff]">
               {showInfo && (
                   <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 animate-fadeIn">
                       <div className="bg-white rounded-xl p-6 max-w-sm w-full text-center shadow-2xl relative border-4 border-purple-200">
                           <button onClick={() => setShowInfo(false)} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600 font-bold text-xl">‚úï</button>
                           <div className="text-4xl mb-2">üë®‚Äçüè´</div>
                           <h3 className="text-xl font-bold text-purple-600 mb-2">Credits</h3>
                           <p className="text-gray-800 font-medium">Developed by Sir Angelo Medez, LPT</p>
                           <p className="text-gray-600 text-sm mt-1">for Grade 5 Science via Gemini Canvas</p>
                       </div>
                   </div>
               )}

               <JournalSidebar stage={stage} isOpen={showJournal} onClose={() => setShowJournal(false)} />

               <div className="bg-white shadow-sm p-3 z-40 flex justify-between items-center shrink-0 relative">
                   <h1 className="text-xl md:text-2xl font-bold text-purple-600 flex items-center gap-2"><span className="text-3xl">‚ö°</span> Ms. Sparkle's Static Lab</h1>
                   <div className="flex gap-2">
                       <div className="relative">
                            <button onClick={() => setShowJournal(!showJournal)} className={`p-2 rounded-full ${showJournal ? 'bg-purple-100 text-purple-600' : 'bg-gray-100 text-gray-600'}`} title="Journal">üìì</button>
                            {stage > 0 && <div className="absolute top-1/2 -translate-y-1/2 right-full mr-2 bg-yellow-300 text-xs font-bold px-2 py-0.5 rounded shadow-sm animate-bounce pointer-events-none whitespace-nowrap bubble-point-right">Open Me!</div>}
                       </div>
                       <button onClick={() => setShowInfo(true)} className="p-2 rounded-full bg-yellow-100 text-yellow-600">‚ÑπÔ∏è</button>
                       <button onClick={toggleMusic} className={`p-2 rounded-full ${settings.music?'bg-purple-100 text-purple-600':'bg-gray-100 text-gray-400'}`}>{settings.music?'üéµ':'üîá'}</button>
                       <button onClick={()=>setSettings(s=>({...s, speak:!s.speak}))} className={`p-2 rounded-full ${settings.speak?'bg-blue-100 text-blue-600':'bg-gray-100 text-gray-400'}`}>{settings.speak?'üó£Ô∏è':'üò∂'}</button>
                       <button onClick={()=>setSettings(s=>({...s, sound:!s.sound}))} className={`p-2 rounded-full ${settings.sound?'bg-green-100 text-green-600':'bg-gray-100 text-gray-400'}`}>{settings.sound?'üîä':'üîá'}</button>
                   </div>
               </div>

               {stage > 0 && stage < 9 && (
                   <div className="w-full max-w-4xl mx-auto px-4 mb-2 shrink-0">
                       <div className="flex justify-between mb-1 overflow-hidden">
                           {labels.slice(1, -1).map((label, idx) => (
                               <div key={idx} className={`text-[10px] whitespace-nowrap ${stage >= idx + 1 ? 'text-purple-600 font-bold' : 'text-gray-300'}`}>{label}</div>
                           ))}
                       </div>
                       <div className="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                           <div className="h-full bg-purple-500 transition-all duration-500" style={{ width: `${((stage - 1) / 7) * 100}%` }}></div>
                       </div>
                   </div>
               )}

               <main className="flex-1 overflow-hidden relative flex flex-col">
                   <div className="flex-1 relative overflow-hidden">
                       {stage === 0 && <IntroScreen onComplete={startApp} settings={settings} />}
                       {stage === 1 && <AtomBuilder onComplete={nextStage} settings={settings} />}
                       {stage === 2 && <ElectronShellLevel onComplete={nextStage} settings={settings} />}
                       {stage === 3 && <ChargesLevel onComplete={nextStage} settings={settings} />}
                       {stage === 4 && <CombLab onComplete={nextStage} settings={settings} />}
                       {stage === 5 && <BalloonLab onComplete={nextStage} settings={settings} />}
                       {stage === 6 && <RealLifeLab onComplete={nextStage} settings={settings} />}
                       {stage === 7 && <QuizLevel onComplete={nextStage} settings={settings} />}
                       {stage === 8 && <SummaryLevel onComplete={nextStage} settings={settings} />}
                       {stage === 9 && <WrapUp settings={settings} />}
                   </div>
               </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
